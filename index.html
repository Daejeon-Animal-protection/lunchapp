<!-- 관리자 페이지 - Firebase 연동된 개인별 식사 통계 탭 -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>관리자 페이지</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { font-family: sans-serif; background: #f2f2f2; padding: 20px; text-align: center; }
    h1 { margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
    th, td { padding: 8px; border: 1px solid #ccc; font-size: 14px; }
    th { background: #e0e0e0; }
    .highlight { background-color: #dff0d8; font-weight: bold; }
  </style>
</head>
<body>
  <div>
    <button id="btnStats">📊 개인별 식사 통계</button>
    <button id="btnExpenses">📋 식당운영비관리</button>
    <button id="btnCharges">💰 식대 징수</button>
  </div>

  <div id="stats" style="display:block">
    <h1>📊 개인별 식사 통계 
      <select id="monthSelect">
        <option value="2025-01">2025년 1월</option>
        <option value="2025-02">2025년 2월</option>
        <option value="2025-03">2025년 3월</option>
        <option value="2025-04">2025년 4월</option>
        <option value="2025-05" selected>2025년 5월</option>
      </select>
      <button onclick="exportTable('statsBody', '개인별식사통계')">엑셀로 추출하기</button>
    </h1>
    <table>
      <thead id="statsHead"></thead>
      <tbody id="statsBody"></tbody>
    </table>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD5TK7QNHXvQsjKNQ7136SxhP_lJ9PdbsM",
      authDomain: "lunch-20bb8.firebaseapp.com",
      projectId: "lunch-20bb8",
      storageBucket: "lunch-20bb8.appspot.com",
      messagingSenderId: "218925939220",
      appId: "1:218925939220:web:4b8940a954f05bfb4a0501",
      measurementId: "G-CH044PJTEL"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const employees = [
      "이영일", "김정이", "이현승", "김성동", "김미지", "박병삼", "김하은", "한수진", "임정아",
      "김혜경", "심규한", "연경순", "임경순", "이민하", "이유미", "이윤희", "최승필", "홍선주",
      "석순옥", "정미경", "이창례", "임주연", "김문정", "김미영", "심장식", "손영복", "손영부",
      "강성필", "김정근", "오화진"
    ];

    function renderStatsTable() {
      const selected = document.getElementById("monthSelect").value;
      const [year, monthStr] = selected.split("-");
      const month = parseInt(monthStr, 10) - 1;
      const publicHolidays = ["2025-05-01", "2025-05-05", "2025-05-06"];

      const days = [];
      const totalDays = new Date(year, month + 1, 0).getDate();
      for (let d = 1; d <= totalDays; d++) {
        const date = new Date(year, month, d);
        const iso = `${year}-${monthStr}-${String(d).padStart(2, '0')}`;
        if (date.getDay() >= 1 && date.getDay() <= 5 && !publicHolidays.includes(iso)) {
          days.push(iso);
        }
      }

      db.ref("mealLogs").once("value").then(snapshot => {
        const mealData = snapshot.val() || {};
        const statsHead = document.getElementById("statsHead");
        const statsBody = document.getElementById("statsBody");

        // 열 헤더: 날짜 목록 + 총합
        statsHead.innerHTML = `<tr><th>이름</th>${days.map(d => `<th>${d.slice(5)}</th>`).join('')}<th>총 식사횟수</th></tr>`;

        // 각 직원별 행 생성
        const rows = employees.map(name => {
          let total = 0;
          const tds = days.map(date => {
            const val = mealData?.[name]?.[date] || '';
            if (val === 'O') total++;
            return `<td>${val}</td>`;
          }).join('');
          return `<tr><td>${name}</td>${tds}<td class="highlight">${total}</td></tr>`;
        });

        statsBody.innerHTML = rows.join('');
      });
    }

    document.getElementById("monthSelect").addEventListener("change", renderStatsTable);
    renderStatsTable();
  </script>
</body>
</html>
