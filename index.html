<!-- ê´€ë¦¬ì í˜ì´ì§€ - Firebase ì—°ë™ëœ ê°œì¸ë³„ ì‹ì‚¬ í†µê³„ íƒ­ -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì í˜ì´ì§€</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { font-family: sans-serif; background: #f2f2f2; padding: 20px; text-align: center; }
    h1 { margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
    th, td { padding: 8px; border: 1px solid #ccc; font-size: 14px; }
    th { background: #e0e0e0; }
    .highlight { background-color: #dff0d8; font-weight: bold; }
  </style>
</head>
<body>
  <div>
    <button id="btnStats">ğŸ“Š ê°œì¸ë³„ ì‹ì‚¬ í†µê³„</button>
    <button id="btnExpenses">ğŸ“‹ ì‹ë‹¹ìš´ì˜ë¹„ê´€ë¦¬</button>
    <button id="btnCharges">ğŸ’° ì‹ëŒ€ ì§•ìˆ˜</button>
  </div>

  <div id="stats" style="display:block">
    <h1>ğŸ“Š ê°œì¸ë³„ ì‹ì‚¬ í†µê³„ 
      <select id="monthSelect">
        <option value="2025-01">2025ë…„ 1ì›”</option>
        <option value="2025-02">2025ë…„ 2ì›”</option>
        <option value="2025-03">2025ë…„ 3ì›”</option>
        <option value="2025-04">2025ë…„ 4ì›”</option>
        <option value="2025-05" selected>2025ë…„ 5ì›”</option>
      </select>
      <button onclick="exportTable('statsBody', 'ê°œì¸ë³„ì‹ì‚¬í†µê³„')">ì—‘ì…€ë¡œ ì¶”ì¶œí•˜ê¸°</button>
    </h1>
    <table>
      <thead id="statsHead"></thead>
      <tbody id="statsBody"></tbody>
    </table>
  </div>

  <div id="expenses" style="display:none">
    <h1>ğŸ“‹ ì‹ë‹¹ìš´ì˜ë¹„ê´€ë¦¬ <button onclick="exportTable('expenseBody', 'ì‹ë‹¹ìš´ì˜ë¹„ê´€ë¦¬')">ì—‘ì…€ë¡œ ì¶”ì¶œí•˜ê¸°</button></h1>
    <table>
      <thead>
        <tr><th>ì›”</th><th>ìˆ˜ì…ì•¡</th><th>ì§€ì¶œì•¡</th><th>ì°¨ì•¡</th></tr>
      </thead>
      <tbody id="expenseBody"></tbody>
    </table>
    <div id="nextExpense"></div>
  </div>

  <div id="charges" style="display:none">
    <h1>ğŸ’° ì‹ëŒ€ ì§•ìˆ˜ 
      <select id="chargeMonthSelect">
        <option value="2025-01">2025ë…„ 1ì›”</option>
        <option value="2025-02">2025ë…„ 2ì›”</option>
        <option value="2025-03">2025ë…„ 3ì›”</option>
        <option value="2025-04">2025ë…„ 4ì›”</option>
        <option value="2025-05" selected>2025ë…„ 5ì›”</option>
      </select>
      <button onclick="exportTable('chargeBody', 'ì‹ëŒ€ì§•ìˆ˜')">ì—‘ì…€ë¡œ ì¶”ì¶œí•˜ê¸°</button>
    </h1>
    <table>
      <thead>
        <tr><th>ì´ë¦„</th><th>ì‹ì‚¬íšŸìˆ˜</th><th>ê¸°ë³¸ ì‹ë¹„</th><th>ì¶”ê°€ ì‹ë¹„</th><th>ì´ì•¡</th></tr>
      </thead>
      <tbody id="chargeBody"></tbody>
    </table>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD5TK7QNHXvQsjKNQ7136SxhP_lJ9PdbsM",
      authDomain: "lunch-20bb8.firebaseapp.com",
      projectId: "lunch-20bb8",
      storageBucket: "lunch-20bb8.appspot.com",
      messagingSenderId: "218925939220",
      appId: "1:218925939220:web:4b8940a954f05bfb4a0501",
      measurementId: "G-CH044PJTEL"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.database();

    document.getElementById("btnStats").onclick = () => showSection("stats");
    document.getElementById("btnExpenses").onclick = () => showSection("expenses");
    document.getElementById("btnCharges").onclick = () => showSection("charges");

    function showSection(id) {
      ["stats", "expenses", "charges"].forEach(sec => {
        document.getElementById(sec).style.display = (sec === id) ? "block" : "none";
      });
    }

    function exportTable(tbodyId, filename) {
      const table = document.createElement("table");
      const thead = document.querySelector(`#${tbodyId}`).parentElement.querySelector("thead");
      const cloneThead = thead.cloneNode(true);
      const cloneTbody = document.getElementById(tbodyId).cloneNode(true);
      table.appendChild(cloneThead);
      table.appendChild(cloneTbody);
      const html = table.outerHTML;
      const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${filename}.xls`;
      a.click();
      URL.revokeObjectURL(url);
    }

    const employees = [
      "ì´ì˜ì¼", "ê¹€ì •ì´", "ì´í˜„ìŠ¹", "ê¹€ì„±ë™", "ê¹€ë¯¸ì§€", "ë°•ë³‘ì‚¼", "ê¹€í•˜ì€", "í•œìˆ˜ì§„", "ì„ì •ì•„",
      "ê¹€í˜œê²½", "ì‹¬ê·œí•œ", "ì—°ê²½ìˆœ", "ì„ê²½ìˆœ", "ì´ë¯¼í•˜", "ì´ìœ ë¯¸", "ì´ìœ¤í¬", "ìµœìŠ¹í•„", "í™ì„ ì£¼",
      "ì„ìˆœì˜¥", "ì •ë¯¸ê²½", "ì´ì°½ë¡€", "ì„ì£¼ì—°", "ê¹€ë¬¸ì •", "ê¹€ë¯¸ì˜", "ì‹¬ì¥ì‹", "ì†ì˜ë³µ", "ì†ì˜ë¶€",
      "ê°•ì„±í•„", "ê¹€ì •ê·¼", "ì˜¤í™”ì§„"
    ];

    function renderStatsTable() {
      const selected = document.getElementById("monthSelect").value;
      const [year, monthStr] = selected.split("-");
      const month = parseInt(monthStr, 10) - 1;
      const publicHolidays = ["2025-05-01", "2025-05-05", "2025-05-06"];

      const days = [];
      const totalDays = new Date(year, month + 1, 0).getDate();
      for (let d = 1; d <= totalDays; d++) {
        const date = new Date(year, month, d);
        const iso = `${year}-${monthStr}-${String(d).padStart(2, '0')}`;
        if (date.getDay() >= 1 && date.getDay() <= 5 && !publicHolidays.includes(iso)) {
          days.push(iso);
        }
      }

      db.ref("mealLogs").once("value").then(snapshot => {
        const mealData = snapshot.val() || {};
        const statsHead = document.getElementById("statsHead");
        const statsBody = document.getElementById("statsBody");

        statsHead.innerHTML = `<tr><th>ë‚ ì§œ</th>${employees.map(name => `<th>${name}</th>`).join('')}<th>ì´ ì‹ì‚¬íšŸìˆ˜</th></tr>`;

        const rows = days.map(date => {
          let count = 0;
          const tds = employees.map(name => {
            const val = mealData?.[name]?.[date] || '';
            if (val === 'O') count++;
            return `<td>${val}</td>`;
          }).join('');
          return `<tr><td>${date}</td>${tds}<td class="highlight">${count}</td></tr>`;
        });

        statsBody.innerHTML = rows.join('');
      });
    }

    function renderChargeTable() {
      const selected = document.getElementById("chargeMonthSelect").value;
      const [year, monthStr] = selected.split("-");
      const month = parseInt(monthStr, 10) - 1;

      const days = [];
      const totalDays = new Date(year, month + 1, 0).getDate();
      for (let d = 1; d <= totalDays; d++) {
        const date = new Date(year, month, d);
        const iso = `${year}-${monthStr}-${String(d).padStart(2, '0')}`;
        if (date.getDay() >= 1 && date.getDay() <= 5) {
          days.push(iso);
        }
      }

      db.ref("mealLogs").once("value").then(snapshot => {
        const mealData = snapshot.val() || {};
        const chargeBody = document.getElementById("chargeBody");
        const rows = employees.map(name => {
          const logs = mealData[name] || {};
          const count = days.filter(date => logs[date] === 'O').length;
          const base = 50000;
          const extra = Math.max(0, count - 10) * 5000;
          const total = base + extra;
          return `<tr><td>${name}</td><td>${count}</td><td>${base.toLocaleString()}</td><td>${extra.toLocaleString()}</td><td>${total.toLocaleString()}</td></tr>`;
        });
        chargeBody.innerHTML = rows.join('');
      });
    }

    document.getElementById("monthSelect").addEventListener("change", renderStatsTable);
    document.getElementById("chargeMonthSelect").addEventListener("change", renderChargeTable);

    renderStatsTable();
    renderChargeTable();

    // ì‹ë‹¹ìš´ì˜ë¹„ê´€ë¦¬ íƒ­ ë°ì´í„° ë Œë”ë§
    const expenseBody = document.getElementById("expenseBody");
    const nextExpense = document.getElementById("nextExpense");

    const revenues = {
      "1ì›”": 265000,
      "2ì›”": 1170000,
      "3ì›”": 1170000,
      "4ì›”": 1905000
    };
    const expenses = {
      "1ì›”": 404650,
      "2ì›”": 1212510,
      "3ì›”": 1171310,
      "4ì›”": 1656100
    };
    const months = ["1ì›”", "2ì›”", "3ì›”", "4ì›”"];
    const nextMonth = "5ì›”";

    const summerAverages = {
      ì›”: 8.57, í™”: 17.36, ìˆ˜: 17.51, ëª©: 18.61, ê¸ˆ: 15.73
    };
    const weekdayCount = { ì›”: 3, í™”: 3, ìˆ˜: 4, ëª©: 5, ê¸ˆ: 5 };
    const unitCost = 4500;
    let totalEstimate = 0;
    for (const [day, avg] of Object.entries(summerAverages)) {
      totalEstimate += avg * (weekdayCount[day] || 0) * unitCost;
    }

    expenseBody.innerHTML = months.map(m => {
      const rev = revenues[m] || 0;
      const exp = expenses[m] || 0;
      const diff = rev - exp;
      return `<tr><td>${m}</td><td>${rev.toLocaleString()}</td><td>${exp.toLocaleString()}</td><td>${diff.toLocaleString()}</td></tr>`;
    }).join('');

    nextExpense.innerHTML = `<h3>ğŸ“Œ ${nextMonth} ì˜ˆìƒì§€ì¶œì•¡: <span class="highlight">${Math.round(totalEstimate).toLocaleString()}ì›</span></h3>`;
  </script>
</body>
</html>
