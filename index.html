<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Lunch Check</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
     body { font-family: sans-serif; background: #f4f4f4; padding: 20px; text-align: center; }
    button { margin: 4px; padding: 8px 12px; }
    .section { display: none; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 12px; }
    th { background-color: #eee; }
    .highlight { font-weight: bold; }
    .small-btn { font-size: 10px; margin-left: 4px; }
    .expense-input { width: 80px; }
    #estimateDetails { display: none; text-align: left; max-width: 600px; margin: 10px auto; font-size: 12px; }
 .group-header { background-color: #ccc;font-weight: bold; font-size: 14px; text-align: center; }
  </style>
</head>
<body>
  <div>
      <button id="btnStats">ğŸ“Š ê°œì¸ë³„ ì‹ì‚¬ í†µê³„</button>
    <button id="btnExpenses">ğŸ“‹ ì‹ë‹¹ìš´ì˜ë¹„ê´€ë¦¬</button>
    <button id="btnCharges">ğŸ’° ì‹ëŒ€ ì§•ìˆ˜</button>
    <button id="btnSettings"âš™ï¸ ì„¤ì •</button>
  </div>

    <!-- ê°œì¸ë³„ ì‹ì‚¬ í†µê³„ ì„¹ì…˜ -->
  <div id="stats" class="section">
    <label>ğŸ“… ì›” ì„ íƒ: </label>
    <select id="monthSelectStats"></select>
    <h1>ğŸ“Š ê°œì¸ë³„ ì‹ì‚¬ í†µê³„</h1>
    <table>
      <thead id="statsHead"></thead>
      <tbody id="statsBody"></tbody>
    </table>
  </div>


   <!-- ì‹ë‹¹ìš´ì˜ë¹„ê´€ë¦¬ ì„¹ì…˜ -->
 <div id="expenses" class="section">
    <label>ğŸ“… ì›” ì„ íƒ: <select id="monthSelectExpenses"></select></label>
    <h1>ğŸ“‹ ì‹ë‹¹ìš´ì˜ë¹„ê´€ë¦¬</h1>
    <button id="addExpenseRow">â• í–‰ ì¶”ê°€</button>
    <table>
      <thead><tr><th>ì›”</th><th>ìˆ˜ì…ì•¡</th><th>ì§€ì¶œì•¡</th><th>ì°¨ì•¡</th><th>ì‚­ì œ</th></tr></thead>
      <tbody id="expenseTableBody"></tbody>
    </table>
    <h2 id="nextMonthEstimate"></h2>
    <button id="toggleEstimate">ìì„¸íˆ ë³´ê¸°</button>
    <div id="estimateDetails"></div>
  </div>

  <!-- ì‹ëŒ€ ì§•ìˆ˜ ì„¹ì…˜ -->
  <div id="charges" class="section">
    <label>ğŸ“… ì›” ì„ íƒ: <select id="monthSelectCharges" onchange="renderChargeTable()"></select></label>
    <h1>ğŸ’° ì‹ëŒ€ ì§•ìˆ˜</h1>
    <table>
      <thead><tr><th>ì´ë¦„</th><th>ì‹ì‚¬íšŸìˆ˜</th><th>ê¸°ë³¸ ì‹ë¹„</th><th>ì¶”ê°€ ì‹ë¹„</th><th>ì´ì•¡</th></tr></thead>
      <tbody id="chargeTableBody"></tbody>
    </table>
  </div>

  <!-- ì„¤ì • ì„¹ì…˜ -->
  <div id="settings" class="section">
    <h1>âš™ï¸ ì„¤ì •</h1>
    <button id="btnEmployees">ğŸ‘¥ ì§ì›ëª©ë¡</button>
    <div id="employeeSettings" style="display:none;">
      <input id="newEmployee" placeholder="ì§ì›ì´ë¦„ ì…ë ¥"/>
      <button id="addEmployeeBtn">â• ì¶”ê°€</button>
      <ul id="employeeList"></ul>
    </div>
  </div>


  <script>
    // Firebase ì´ˆê¸°í™”
    firebase.initializeApp({
      apiKey: "AIzaSyD5TK7QNHXvQsjKNQ7136SxhP_lJ9PdbsM",
      authDomain: "lunch-20bb8.firebaseapp.com",
      databaseURL: "https://lunch-20bb8-default-rtdb.firebaseio.com",
      projectId: "lunch-20bb8"
    });
    const db = firebase.database();
    let employees = [];
    let regularList = ["ì´ì˜ì¼","ì´í˜„ìŠ¹","ê¹€ì„±ë™","ë°•ë³‘ì‚¼","ê¹€í•˜ì€","ê¹€ë¯¸ì§€","í•œìˆ˜ì§„","ê¹€í˜œê²½","ì„ì •ì•„"];
const expenseData = [
    { month:'2025-01', income:265000, expense:404650 },
    { month:'2025-02', income:1170000, expense:1212510 },
    { month:'2025-03', income:1170000, expense:1171310 },
    { month:'2025-04', income:1905000, expense:1656100 }
  ];

    //ì›”ì„ íƒ
   function initMonthOptions(id) {
        const sel = document.getElementById(id);
        if (!sel) return;
        sel.innerHTML = '';
        const now = new Date(), year = now.getFullYear();
        for (let m = 1; m <= 12; m++) {
          const mm = String(m).padStart(2,'0');
          sel.append(new Option(`${year}-${mm}`, `${year}-${mm}`));
        }
        const defaultVal = `${year}-${String(now.getMonth()+1).padStart(2,'0')}`;
        sel.value = defaultVal;
      }

  function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.style.display='none');
    const sec = document.getElementById(id);
    if (sec) sec.style.display='block';
  }

    async function getKoreanHolidays(y, m) {
      const rawKey = 'dtZOAdfRz5FEy2NGFBIEaHoQhfimWGWodsA2Wzcr+eSSdv1nDcyXk9REdGCzZuZPp32hkYvNFgHJJBeOhQ6H0g==';
      const serviceKey = encodeURIComponent(rawKey);
      const mm = String(m).padStart(2, '0');
      const url = `https://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo`
        + `?ServiceKey=${serviceKey}`
        + `&solYear=${y}`
        + `&solMonth=${mm}`
        + `&numOfRows=31&pageNo=1&_type=json`;
      console.log('ğŸŒ Fetching holiday URL:', url);
      const res = await fetch(url);
      const text = await res.text();
      console.log('ğŸ“„ Raw holiday response:', text);
      try {
        const json = JSON.parse(text);
        const items = json.response.body.items?.item || [];
        return items.map(i => {
          const s = i.locdate.toString();
          return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
        });
      } catch (error) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(text, 'application/xml');
        const xmlItems = xmlDoc.getElementsByTagName('item');
        return Array.from(xmlItems).map(item => {
          const s = item.getElementsByTagName('locdate')[0].textContent;
          return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
        });
      }
    }

  async function generateWorkdaysForMonth(y,m) {
 const holidays = await getKoreanHolidays(y, m);
    const days=[];
    const total=new Date(y,m,0).getDate();
    const mm=String(m).padStart(2,'0');
   for (let d = 1; d <= total; d++){
    const iso = `${y}-${mm}-${String(d).padStart(2,'0')}`;
    const dow = new Date(iso).getDay();
    if (dow === 0 || dow === 6) continue;   
    if (holidays.includes(iso)) continue;      days.push(iso);
    }
    return days;
  }

async function renderStatsTable() {
 if (document.getElementById('stats').style.display === 'none') {
    return;
  }
   if (!employees.length) {
    const snapEmp = await db.ref('employees').once('value');
    employees = Object.keys(snapEmp.val() || {});
  }
   const sel = document.getElementById('monthSelectStats').value;
  const [y, m] = sel.split('-').map(Number);

  // ê³µíœ´ì¼Â·ì£¼ë§ ì œì™¸ í‰ì¼ ë°°ì—´ ê°€ì ¸ì˜¤ê¸°
  const sd = await generateWorkdaysForMonth(y, m);
 if (document.getElementById('stats').style.display === 'none') return;
  // í…Œì´ë¸” í—¤ë” ë Œë”ë§í…Œ
  const thead = document.getElementById('statsHead');
  thead.innerHTML = '';
  const headRow = document.createElement('tr');
  headRow.innerHTML = `<th>ì´ë¦„</th>`
    + sd.map(d => `<th>${d.slice(5)}</th>`).join('')
    + `<th>ì´í•©</th>`;
  thead.appendChild(headRow);

  // ë°ì´í„° ê°€ì ¸ì™€ì„œ ê·¸ë£¹ë³„ ë Œë”ë§
  const snapshot = await db.ref('mealLogs').once('value');
  const data = snapshot.val() || {};
  const tbody = document.getElementById('statsBody');
  tbody.innerHTML = '';

  ['ì¼ë°˜ì§','ê¸°ê°„ì œ'].forEach(group => {
    // ê·¸ë£¹ í—¤ë”
    const headerRow = document.createElement('tr');
    headerRow.className = 'group-header';
    headerRow.innerHTML = `<td colspan="${2 + sd.length + 1}">${group}</td>`;
    tbody.appendChild(headerRow);

    const list = group === 'ì¼ë°˜ì§'
      ? employees.filter(n => regularList.includes(n))
      : employees.filter(n => !regularList.includes(n));

    // ì§ì›ë³„ í–‰
    list.forEach(name => {
      let cnt = 0;
      const row = document.createElement('tr');
      row.innerHTML = `<td>${name}</td>`
        + sd.map(d => {
            const v = data[name]?.[d] || '';
            if (v === 'O') cnt++;
            return `<td>${v}</td>`;
          }).join('')
        + `<td class="highlight">${cnt}</td>`;
      tbody.appendChild(row);
    });
  });
}

    //ì‹ëŒ€ì§•ìˆ˜ ê¸°ëŠ¥
     function renderChargeTable() {
  const sel   = document.getElementById('monthSelectCharges').value;
  const tbody = document.getElementById('chargeTableBody');
  tbody.innerHTML = '';

  // â† Promiseë¥¼ ë°˜í™˜í•˜ë„ë¡ return ì¶”ê°€!
  return db.ref('mealLogs').once('value').then(snapshot => {
    const data = snapshot.val() || {};
    let sumTotal = 0;

    ['ì¼ë°˜ì§','ê¸°ê°„ì œ'].forEach(group => {
      // ê·¸ë£¹ í—¤ë”
      const headerRow = document.createElement('tr');
      headerRow.className = 'group-header';
      headerRow.innerHTML = `<td colspan="5">${group}</td>`;
      tbody.appendChild(headerRow);

      let groupSum = 0;
      const list = group === 'ì¼ë°˜ì§'
        ? employees.filter(n => regularList.includes(n))
        : employees.filter(n => !regularList.includes(n));

      list.forEach(name => {
        const cnt   = Object.entries(data[name] || {})
                          .filter(([d,v]) => d.startsWith(sel) && v === 'O')
                          .length;
        const basic = 50000;
        const extra = Math.max(0, cnt - 10) * 5000;
        const total = basic + extra;

        groupSum += total;
        sumTotal  += total;

        const row = document.createElement('tr');
        row.innerHTML =
          `<td>${name}</td>` +
          `<td>${cnt}</td>` +
          `<td>${basic.toLocaleString()}</td>` +
          `<td>${extra.toLocaleString()}</td>` +
          `<td>${total.toLocaleString()}</td>`;
        tbody.appendChild(row);
      });

      // ì†Œê³„ í–‰
      const subtotalRow = document.createElement('tr');
      subtotalRow.className = 'subtotal-row';
      subtotalRow.innerHTML =
        `<td colspan="4" style="text-align:right;"><strong>${group} ì†Œê³„</strong></td>` +
        `<td><strong>${groupSum.toLocaleString()}</strong></td>`;
      tbody.appendChild(subtotalRow);
    });

    // ì „ì²´ í•©ê³„ í–‰
    const totalRow = document.createElement('tr');
    totalRow.className = 'total-row';
    totalRow.innerHTML =
      `<td colspan="4" style="text-align:right;"><strong>ì´í•©ê³„</strong></td>` +
      `<td><strong>${sumTotal.toLocaleString()}</strong></td>`;
    tbody.appendChild(totalRow);

    return sumTotal;  // â† ì—¬ê¸°ì„œ Promiseê°€ resolveí•  ê°’
  });
}


function renderEmployeeList() {
  const ul = document.getElementById("employeeList");
  ul.innerHTML = '';

  if (employees.length === 0) {
    ul.innerHTML = '<li style="color:gray">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
    return;
  }

  // --- ì¼ë°˜ì§ ê·¸ë£¹ ì •ì˜ ---
  const regGroupLi = document.createElement('li');
  regGroupLi.innerHTML = '<strong>ì¼ë°˜ì§</strong>';
  const regSubUl = document.createElement('ul');
  regGroupLi.appendChild(regSubUl);
  ul.appendChild(regGroupLi);

  // --- ê¸°ê°„ì œ ê·¸ë£¹ ì •ì˜ ---
  const conGroupLi = document.createElement('li');
  conGroupLi.innerHTML = '<strong>ê¸°ê°„ì œ</strong>';
  const conSubUl = document.createElement('ul');
  conGroupLi.appendChild(conSubUl);
  ul.appendChild(conGroupLi);

  // --- ì§ì›ë³„ í–‰ ì¶”ê°€ ---
  employees.forEach(name => {
    const isRegular = regularList.includes(name);
    addRow(name, isRegular ? regSubUl : conSubUl);
  });
}

function addRow(name, parentUl) {
  const li = document.createElement('li');
  li.style.display = 'flex';
  li.style.alignItems = 'center';
  li.style.columnGap = '4px';

  // ì´ë¦„ input
  const input = document.createElement('input');
  input.type = 'text';
  input.value = name;
  input.disabled = true;
  input.style.flex = '0 0 120px';
  li.appendChild(input);

  // ë²„íŠ¼ ìƒì„± í—¬í¼
  function makeBtn(label, onClick) {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = label;
    btn.addEventListener('click', e => {
      e.preventDefault();
      onClick();
    });
    li.appendChild(btn);
  }

  // âœï¸ ìˆ˜ì •
  makeBtn('âœï¸', () => {
    input.disabled = false;
    input.focus();
  });

  // ğŸ“‚ ì €ì¥
  makeBtn('ğŸ“‚', () => {
    const nv = input.value.trim();
    if (nv && nv !== name) {
      const idx = employees.indexOf(name);
      employees[idx] = nv;
      db.ref('employees').set(employees);
      renderEmployeeList();
    }
  });

  // ğŸ”¼ ìœ„ë¡œ
  makeBtn('ğŸ”¼', () => {
    const i = employees.indexOf(name);
    if (i > 0) {
      [employees[i-1], employees[i]] = [employees[i], employees[i-1]];
      db.ref('employees').set(employees);
      renderEmployeeList();
    }
  });

  // ğŸ”½ ì•„ë˜ë¡œ
  makeBtn('ğŸ”½', () => {
    const i = employees.indexOf(name);
    if (i < employees.length - 1) {
      [employees[i], employees[i+1]] = [employees[i+1], employees[i]];
      db.ref('employees').set(employees);
      renderEmployeeList();
    }
  });

  // â†”ï¸ ì§êµ° ì´ë™
  makeBtn(
    regularList.includes(name) ? 'â¡ï¸ ê¸°ê°„ì œ' : 'â¬…ï¸ ì¼ë°˜ì§',
    () => {
      if (regularList.includes(name)) {
        regularList = regularList.filter(n => n !== name);
      } else {
        regularList.push(name);
      }
      db.ref('employees').set(employees);
      renderEmployeeList();
    }
  );

  // âŒ ì‚­ì œ
  makeBtn('âŒ', () => {
    const i = employees.indexOf(name);
    employees.splice(i, 1);
    db.ref('employees').set(employees);
    renderEmployeeList();
  });

  // ê·¸ë£¹ ULì— ë¶™ì´ê¸°
  parentUl.appendChild(li);
}

     function addEmployee() {
    const input = document.getElementById('newEmployee');
    const name = input.value.trim();
    if (name && !employees.includes(name)) {
      employees.push(name);
      regularList.push(name);
      db.ref('employees').set(employees);
      input.value = '';
      renderEmployeeList();
    }
  }

//ì‹ë‹¹ìš´ì˜ë¹„ê´€ë¦¬
    function renderExpenseTable() {
  const tbody = document.getElementById('expenseTableBody');
  tbody.innerHTML = '';
  renderChargeTable().then(totalIncome => {
    expenseData.forEach((it, i) => {
      const diff = totalIncome - it.expense;
      const tr   = document.createElement('tr');

      tr.innerHTML =
        `<td>${it.month}</td>` +
        `<td>${totalIncome.toLocaleString()}</td>` +
        `<td><span class="expense-value">${it.expense.toLocaleString()}</span> ` +
          `<button class="small-btn edit-expense">âœï¸</button></td>` +
        `<td class="highlight">${diff.toLocaleString()}</td>` +
        `<td><button class="small-btn delete-expense">âŒ</button></td>`;
      tr.querySelector('.edit-expense').onclick = () => {
        const span = tr.querySelector('.expense-value');
        const oldVal = span.textContent.replace(/,/g, '');
        const input = document.createElement('input'); input.type = 'number'; input.value = oldVal; input.classList.add('expense-input');
        span.replaceWith(input); input.focus();
        input.onblur = () => { it.expense = parseInt(input.value) || 0; renderExpenseTable(); };
      };
      tr.querySelector('.delete-expense').onclick = () => { expenseData.splice(i, 1); renderExpenseTable(); };
       tbody.appendChild(tr);
    });

    updateEstimate();
  })
  .catch(err => console.error(err));
}

  //ì˜ˆìƒì§€ì¶œì•¡
    async function updateEstimate() {
    const sel = document.getElementById('monthSelect').value;
    const [y, m] = sel.split('-').map(Number);
const days = new Date(y, m, 0).getDate(); 
    const wk = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    const cnt = { 'ì›”':0, 'í™”':0, 'ìˆ˜':0, 'ëª©':0, 'ê¸ˆ':0 };
   const holidays = await getKoreanHolidays(y, m);
if (cnt[w] !== undefined && !holidays.includes(ds)) cnt[w]++;
    const avg = { summer:{'ì›”':8.49,'í™”':17.33,'ìˆ˜':17.94,'ëª©':18.95,'ê¸ˆ':15.66}, winter:{'ì›”':7.28,'í™”':13.83,'ìˆ˜':14.81,'ëª©':15.26,'ê¸ˆ':13.5} };
    const season = (m >= 4 && m <= 9) ? 'summer' : 'winter';
    const cost = 4500;
    let est = 0;
    Object.entries(cnt).forEach(([d, c]) => { est += avg[season][d] * c * cost; });
    document.getElementById('nextMonthEstimate').textContent = `${sel} ì˜ˆìƒ ì§€ì¶œì•¡: ${Math.round(est).toLocaleString()}ì›`;
    const expr = Object.entries(cnt).map(([d, c]) => `(${d}:${c}ì¼Ã—${avg[season][d]}ëª…Ã—${cost}ì›)`).join(' + ');
    document.getElementById('estimateDetails').innerHTML = `<strong>ê³„ì‚° ê·¼ê±°:</strong><br><em>í‰ê· Ã—í‰ì¼Ã—ì¸ë‹¹ ${cost.toLocaleString()}ì›</em><br><strong>ê³„ì‚°ì‹:</strong>${expr} = ${Math.round(est).toLocaleString()}ì›`;
  }
function getChargeTotal() {
  return expenseData
    .reduce((sum, item) => {
      // item.expenseê°€ ë¬¸ìì—´ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ìˆ«ìë¡œ ë³€í™˜
      const val = typeof item.expense === 'number'
        ? item.expense
        : parseInt(item.expense.replace(/,/g,''), 10) || 0;
      return sum + val;
    }, 0);
}
  


     document.addEventListener('DOMContentLoaded', () => {
 initMonthOptions('monthSelectStats');
    initMonthOptions('monthSelectExpenses');
    initMonthOptions('monthSelectCharges');
    db.ref('employees').on('value', snap => { employees = snap.val() || []; renderEmployeeList(); });
 document.getElementById('monthSelectStats')
          .addEventListener('change', renderStatsTable);
    document.getElementById('btnStats').onclick = () => { showSection('stats'); renderStatsTable(); };
    document.getElementById('btnExpenses').onclick = () => { showSection('expenses'); renderExpenseTable(); };
    document.getElementById('btnCharges').onclick = () => { showSection('charges'); renderChargeTable(); };
    document.getElementById('btnSettings').onclick = () => { showSection('settings'); };
    document.getElementById('btnEmployees').onclick = () => { const es = document.getElementById('employeeSettings'); es.style.display = es.style.display==='none'?'block':'none'; };
    document.getElementById('addEmployeeBtn').onclick = addEmployee;
    document.getElementById('addExpenseRow').onclick = () => { const m = document.getElementById('monthSelect').value; if (!expenseData.some(e=>e.month===m)) expenseData.push({month:m, income:getChargeTotal(), expense:0}); renderExpenseTable(); };
    document.getElementById('toggleEstimate').onclick = () => { const d = document.getElementById('estimateDetails'); d.style.display = d.style.display==='none'?'block':'none'; };
    showSection('stats');
  });

  </script>
</body>
</html>
