<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Lunch Check</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
     body { font-family: sans-serif; background: #f4f4f4; padding: 20px; text-align: center; }
    button { margin: 4px; padding: 8px 12px; }
    .section { display: none; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 12px; }
    th { background-color: #eee; }
    .highlight { font-weight: bold; }
    .small-btn { font-size: 10px; margin-left: 4px; }
    .expense-input { width: 80px; }
    #estimateDetails { display: none; text-align: left; max-width: 600px; margin: 10px auto; font-size: 12px; }
 .group-header { background-color: #ccc;font-weight: bold; font-size: 14px; text-align: center; }
  </style>
</head>
<body>
  <div>
      <button id="btnStats">📊 개인별 식사 통계</button>
    <button id="btnExpenses">📋 식당운영비관리</button>
    <button id="btnCharges">💰 식대 징수</button>
    <button id="btnSettings"⚙️ 설정</button>
  </div>

    <!-- 개인별 식사 통계 섹션 -->
  <div id="stats" class="section">
    <label>📅 월 선택: </label>
    <select id="monthSelectStats"></select>
    <h1>📊 개인별 식사 통계</h1>
    <table>
      <thead id="statsHead"></thead>
      <tbody id="statsBody"></tbody>
    </table>
  </div>


   <!-- 식당운영비관리 섹션 -->
 <div id="expenses" class="section">
    <label>📅 월 선택: <select id="monthSelectExpenses"></select></label>
    <h1>📋 식당운영비관리</h1>
    <button id="addExpenseRow">➕ 행 추가</button>
    <table>
      <thead><tr><th>월</th><th>수입액</th><th>지출액</th><th>차액</th><th>삭제</th></tr></thead>
      <tbody id="expenseTableBody"></tbody>
    </table>
    <h2 id="nextMonthEstimate"></h2>
    <button id="toggleEstimate">자세히 보기</button>
    <div id="estimateDetails"></div>
  </div>

  <!-- 식대 징수 섹션 -->
  <div id="charges" class="section">
    <label>📅 월 선택: <select id="monthSelectCharges" onchange="renderChargeTable()"></select></label>
    <h1>💰 식대 징수</h1>
    <table>
      <thead><tr><th>이름</th><th>식사횟수</th><th>기본 식비</th><th>추가 식비</th><th>총액</th></tr></thead>
      <tbody id="chargeTableBody"></tbody>
    </table>
  </div>

  <!-- 설정 섹션 -->
  <div id="settings" class="section">
    <h1>⚙️ 설정</h1>
    <button id="btnEmployees">👥 직원목록</button>
    <div id="employeeSettings" style="display:none;">
      <input id="newEmployee" placeholder="직원이름 입력"/>
      <button id="addEmployeeBtn">➕ 추가</button>
      <ul id="employeeList"></ul>
    </div>
  </div>


  <script>
    // Firebase 초기화
    firebase.initializeApp({
      apiKey: "AIzaSyD5TK7QNHXvQsjKNQ7136SxhP_lJ9PdbsM",
      authDomain: "lunch-20bb8.firebaseapp.com",
      databaseURL: "https://lunch-20bb8-default-rtdb.firebaseio.com",
      projectId: "lunch-20bb8"
    });
    const db = firebase.database();
    let employees = [];
    let regularList = ["이영일","이현승","김성동","박병삼","김하은","김미지","한수진","김혜경","임정아"];
const expenseData = [
    { month:'2025-01', income:265000, expense:404650 },
    { month:'2025-02', income:1170000, expense:1212510 },
    { month:'2025-03', income:1170000, expense:1171310 },
    { month:'2025-04', income:1905000, expense:1656100 }
  ];

    //월선택
   function initMonthOptions(id) {
        const sel = document.getElementById(id);
        if (!sel) return;
        sel.innerHTML = '';
        const now = new Date(), year = now.getFullYear();
        for (let m = 1; m <= 12; m++) {
          const mm = String(m).padStart(2,'0');
          sel.append(new Option(`${year}-${mm}`, `${year}-${mm}`));
        }
        const defaultVal = `${year}-${String(now.getMonth()+1).padStart(2,'0')}`;
        sel.value = defaultVal;
      }

  function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.style.display='none');
    const sec = document.getElementById(id);
    if (sec) sec.style.display='block';
  }

    async function getKoreanHolidays(y, m) {
      const rawKey = 'dtZOAdfRz5FEy2NGFBIEaHoQhfimWGWodsA2Wzcr+eSSdv1nDcyXk9REdGCzZuZPp32hkYvNFgHJJBeOhQ6H0g==';
      const serviceKey = encodeURIComponent(rawKey);
      const mm = String(m).padStart(2, '0');
      const url = `https://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo`
        + `?ServiceKey=${serviceKey}`
        + `&solYear=${y}`
        + `&solMonth=${mm}`
        + `&numOfRows=31&pageNo=1&_type=json`;
      console.log('🌐 Fetching holiday URL:', url);
      const res = await fetch(url);
      const text = await res.text();
      console.log('📄 Raw holiday response:', text);
      try {
        const json = JSON.parse(text);
        const items = json.response.body.items?.item || [];
        return items.map(i => {
          const s = i.locdate.toString();
          return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
        });
      } catch (error) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(text, 'application/xml');
        const xmlItems = xmlDoc.getElementsByTagName('item');
        return Array.from(xmlItems).map(item => {
          const s = item.getElementsByTagName('locdate')[0].textContent;
          return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
        });
      }
    }

  async function generateWorkdaysForMonth(y,m) {
 const holidays = await getKoreanHolidays(y, m);
    const days=[];
    const total=new Date(y,m,0).getDate();
    const mm=String(m).padStart(2,'0');
   for (let d = 1; d <= total; d++){
    const iso = `${y}-${mm}-${String(d).padStart(2,'0')}`;
    const dow = new Date(iso).getDay();
    if (dow === 0 || dow === 6) continue;   
    if (holidays.includes(iso)) continue;      days.push(iso);
    }
    return days;
  }

async function renderStatsTable() {
 if (document.getElementById('stats').style.display === 'none') {
    return;
  }
   if (!employees.length) {
    const snapEmp = await db.ref('employees').once('value');
    employees = Object.keys(snapEmp.val() || {});
  }
   const sel = document.getElementById('monthSelectStats').value;
  const [y, m] = sel.split('-').map(Number);

  // 공휴일·주말 제외 평일 배열 가져오기
  const sd = await generateWorkdaysForMonth(y, m);
 if (document.getElementById('stats').style.display === 'none') return;
  // 테이블 헤더 렌더링테
  const thead = document.getElementById('statsHead');
  thead.innerHTML = '';
  const headRow = document.createElement('tr');
  headRow.innerHTML = `<th>이름</th>`
    + sd.map(d => `<th>${d.slice(5)}</th>`).join('')
    + `<th>총합</th>`;
  thead.appendChild(headRow);

  // 데이터 가져와서 그룹별 렌더링
  const snapshot = await db.ref('mealLogs').once('value');
  const data = snapshot.val() || {};
  const tbody = document.getElementById('statsBody');
  tbody.innerHTML = '';

  ['일반직','기간제'].forEach(group => {
    // 그룹 헤더
    const headerRow = document.createElement('tr');
    headerRow.className = 'group-header';
    headerRow.innerHTML = `<td colspan="${2 + sd.length + 1}">${group}</td>`;
    tbody.appendChild(headerRow);

    const list = group === '일반직'
      ? employees.filter(n => regularList.includes(n))
      : employees.filter(n => !regularList.includes(n));

    // 직원별 행
    list.forEach(name => {
      let cnt = 0;
      const row = document.createElement('tr');
      row.innerHTML = `<td>${name}</td>`
        + sd.map(d => {
            const v = data[name]?.[d] || '';
            if (v === 'O') cnt++;
            return `<td>${v}</td>`;
          }).join('')
        + `<td class="highlight">${cnt}</td>`;
      tbody.appendChild(row);
    });
  });
}

    //식대징수 기능
     function renderChargeTable() {
  const sel   = document.getElementById('monthSelectCharges').value;
  const tbody = document.getElementById('chargeTableBody');
  tbody.innerHTML = '';

  // ← Promise를 반환하도록 return 추가!
  return db.ref('mealLogs').once('value').then(snapshot => {
    const data = snapshot.val() || {};
    let sumTotal = 0;

    ['일반직','기간제'].forEach(group => {
      // 그룹 헤더
      const headerRow = document.createElement('tr');
      headerRow.className = 'group-header';
      headerRow.innerHTML = `<td colspan="5">${group}</td>`;
      tbody.appendChild(headerRow);

      let groupSum = 0;
      const list = group === '일반직'
        ? employees.filter(n => regularList.includes(n))
        : employees.filter(n => !regularList.includes(n));

      list.forEach(name => {
        const cnt   = Object.entries(data[name] || {})
                          .filter(([d,v]) => d.startsWith(sel) && v === 'O')
                          .length;
        const basic = 50000;
        const extra = Math.max(0, cnt - 10) * 5000;
        const total = basic + extra;

        groupSum += total;
        sumTotal  += total;

        const row = document.createElement('tr');
        row.innerHTML =
          `<td>${name}</td>` +
          `<td>${cnt}</td>` +
          `<td>${basic.toLocaleString()}</td>` +
          `<td>${extra.toLocaleString()}</td>` +
          `<td>${total.toLocaleString()}</td>`;
        tbody.appendChild(row);
      });

      // 소계 행
      const subtotalRow = document.createElement('tr');
      subtotalRow.className = 'subtotal-row';
      subtotalRow.innerHTML =
        `<td colspan="4" style="text-align:right;"><strong>${group} 소계</strong></td>` +
        `<td><strong>${groupSum.toLocaleString()}</strong></td>`;
      tbody.appendChild(subtotalRow);
    });

    // 전체 합계 행
    const totalRow = document.createElement('tr');
    totalRow.className = 'total-row';
    totalRow.innerHTML =
      `<td colspan="4" style="text-align:right;"><strong>총합계</strong></td>` +
      `<td><strong>${sumTotal.toLocaleString()}</strong></td>`;
    tbody.appendChild(totalRow);

    return sumTotal;  // ← 여기서 Promise가 resolve할 값
  });
}


function renderEmployeeList() {
  const ul = document.getElementById("employeeList");
  ul.innerHTML = '';

  if (employees.length === 0) {
    ul.innerHTML = '<li style="color:gray">등록된 직원이 없습니다.</li>';
    return;
  }

  // --- 일반직 그룹 정의 ---
  const regGroupLi = document.createElement('li');
  regGroupLi.innerHTML = '<strong>일반직</strong>';
  const regSubUl = document.createElement('ul');
  regGroupLi.appendChild(regSubUl);
  ul.appendChild(regGroupLi);

  // --- 기간제 그룹 정의 ---
  const conGroupLi = document.createElement('li');
  conGroupLi.innerHTML = '<strong>기간제</strong>';
  const conSubUl = document.createElement('ul');
  conGroupLi.appendChild(conSubUl);
  ul.appendChild(conGroupLi);

  // --- 직원별 행 추가 ---
  employees.forEach(name => {
    const isRegular = regularList.includes(name);
    addRow(name, isRegular ? regSubUl : conSubUl);
  });
}

function addRow(name, parentUl) {
  const li = document.createElement('li');
  li.style.display = 'flex';
  li.style.alignItems = 'center';
  li.style.columnGap = '4px';

  // 이름 input
  const input = document.createElement('input');
  input.type = 'text';
  input.value = name;
  input.disabled = true;
  input.style.flex = '0 0 120px';
  li.appendChild(input);

  // 버튼 생성 헬퍼
  function makeBtn(label, onClick) {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = label;
    btn.addEventListener('click', e => {
      e.preventDefault();
      onClick();
    });
    li.appendChild(btn);
  }

  // ✏️ 수정
  makeBtn('✏️', () => {
    input.disabled = false;
    input.focus();
  });

  // 📂 저장
  makeBtn('📂', () => {
    const nv = input.value.trim();
    if (nv && nv !== name) {
      const idx = employees.indexOf(name);
      employees[idx] = nv;
      db.ref('employees').set(employees);
      renderEmployeeList();
    }
  });

  // 🔼 위로
  makeBtn('🔼', () => {
    const i = employees.indexOf(name);
    if (i > 0) {
      [employees[i-1], employees[i]] = [employees[i], employees[i-1]];
      db.ref('employees').set(employees);
      renderEmployeeList();
    }
  });

  // 🔽 아래로
  makeBtn('🔽', () => {
    const i = employees.indexOf(name);
    if (i < employees.length - 1) {
      [employees[i], employees[i+1]] = [employees[i+1], employees[i]];
      db.ref('employees').set(employees);
      renderEmployeeList();
    }
  });

  // ↔️ 직군 이동
  makeBtn(
    regularList.includes(name) ? '➡️ 기간제' : '⬅️ 일반직',
    () => {
      if (regularList.includes(name)) {
        regularList = regularList.filter(n => n !== name);
      } else {
        regularList.push(name);
      }
      db.ref('employees').set(employees);
      renderEmployeeList();
    }
  );

  // ❌ 삭제
  makeBtn('❌', () => {
    const i = employees.indexOf(name);
    employees.splice(i, 1);
    db.ref('employees').set(employees);
    renderEmployeeList();
  });

  // 그룹 UL에 붙이기
  parentUl.appendChild(li);
}

     function addEmployee() {
    const input = document.getElementById('newEmployee');
    const name = input.value.trim();
    if (name && !employees.includes(name)) {
      employees.push(name);
      regularList.push(name);
      db.ref('employees').set(employees);
      input.value = '';
      renderEmployeeList();
    }
  }

//식당운영비관리
    function renderExpenseTable() {
  const tbody = document.getElementById('expenseTableBody');
  tbody.innerHTML = '';
  renderChargeTable().then(totalIncome => {
    expenseData.forEach((it, i) => {
      const diff = totalIncome - it.expense;
      const tr   = document.createElement('tr');

      tr.innerHTML =
        `<td>${it.month}</td>` +
        `<td>${totalIncome.toLocaleString()}</td>` +
        `<td><span class="expense-value">${it.expense.toLocaleString()}</span> ` +
          `<button class="small-btn edit-expense">✏️</button></td>` +
        `<td class="highlight">${diff.toLocaleString()}</td>` +
        `<td><button class="small-btn delete-expense">❌</button></td>`;
      tr.querySelector('.edit-expense').onclick = () => {
        const span = tr.querySelector('.expense-value');
        const oldVal = span.textContent.replace(/,/g, '');
        const input = document.createElement('input'); input.type = 'number'; input.value = oldVal; input.classList.add('expense-input');
        span.replaceWith(input); input.focus();
        input.onblur = () => { it.expense = parseInt(input.value) || 0; renderExpenseTable(); };
      };
      tr.querySelector('.delete-expense').onclick = () => { expenseData.splice(i, 1); renderExpenseTable(); };
       tbody.appendChild(tr);
    });

    updateEstimate();
  })
  .catch(err => console.error(err));
}

  //예상지출액
    async function updateEstimate() {
    const sel = document.getElementById('monthSelect').value;
    const [y, m] = sel.split('-').map(Number);
const days = new Date(y, m, 0).getDate(); 
    const wk = ['일','월','화','수','목','금','토'];
    const cnt = { '월':0, '화':0, '수':0, '목':0, '금':0 };
   const holidays = await getKoreanHolidays(y, m);
if (cnt[w] !== undefined && !holidays.includes(ds)) cnt[w]++;
    const avg = { summer:{'월':8.49,'화':17.33,'수':17.94,'목':18.95,'금':15.66}, winter:{'월':7.28,'화':13.83,'수':14.81,'목':15.26,'금':13.5} };
    const season = (m >= 4 && m <= 9) ? 'summer' : 'winter';
    const cost = 4500;
    let est = 0;
    Object.entries(cnt).forEach(([d, c]) => { est += avg[season][d] * c * cost; });
    document.getElementById('nextMonthEstimate').textContent = `${sel} 예상 지출액: ${Math.round(est).toLocaleString()}원`;
    const expr = Object.entries(cnt).map(([d, c]) => `(${d}:${c}일×${avg[season][d]}명×${cost}원)`).join(' + ');
    document.getElementById('estimateDetails').innerHTML = `<strong>계산 근거:</strong><br><em>평균×평일×인당 ${cost.toLocaleString()}원</em><br><strong>계산식:</strong>${expr} = ${Math.round(est).toLocaleString()}원`;
  }
function getChargeTotal() {
  return expenseData
    .reduce((sum, item) => {
      // item.expense가 문자열일 수 있으니 숫자로 변환
      const val = typeof item.expense === 'number'
        ? item.expense
        : parseInt(item.expense.replace(/,/g,''), 10) || 0;
      return sum + val;
    }, 0);
}
  


     document.addEventListener('DOMContentLoaded', () => {
 initMonthOptions('monthSelectStats');
    initMonthOptions('monthSelectExpenses');
    initMonthOptions('monthSelectCharges');
    db.ref('employees').on('value', snap => { employees = snap.val() || []; renderEmployeeList(); });
 document.getElementById('monthSelectStats')
          .addEventListener('change', renderStatsTable);
    document.getElementById('btnStats').onclick = () => { showSection('stats'); renderStatsTable(); };
    document.getElementById('btnExpenses').onclick = () => { showSection('expenses'); renderExpenseTable(); };
    document.getElementById('btnCharges').onclick = () => { showSection('charges'); renderChargeTable(); };
    document.getElementById('btnSettings').onclick = () => { showSection('settings'); };
    document.getElementById('btnEmployees').onclick = () => { const es = document.getElementById('employeeSettings'); es.style.display = es.style.display==='none'?'block':'none'; };
    document.getElementById('addEmployeeBtn').onclick = addEmployee;
    document.getElementById('addExpenseRow').onclick = () => { const m = document.getElementById('monthSelect').value; if (!expenseData.some(e=>e.month===m)) expenseData.push({month:m, income:getChargeTotal(), expense:0}); renderExpenseTable(); };
    document.getElementById('toggleEstimate').onclick = () => { const d = document.getElementById('estimateDetails'); d.style.display = d.style.display==='none'?'block':'none'; };
    showSection('stats');
  });

  </script>
</body>
</html>
