<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì í˜ì´ì§€</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { font-family: sans-serif; background: #f2f2f2; padding: 20px; text-align: center; }
    h1 { margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
    th, td { padding: 8px; border: 1px solid #ccc; font-size: 14px; }
    th { background: #e0e0e0; }
    .highlight { background-color: #dff0d8; font-weight: bold; }
  </style>
</head>
<body>
  <div>
    <button id="btnStats">ğŸ“Š ê°œì¸ë³„ ì‹ì‚¬ í†µê³„</button>
    <button id="btnExpenses">ğŸ“‹ ì‹ë‹¹ìš´ì˜ë¹„ê´€ë¦¬</button>
    <button id="btnCharges">ğŸ’° ì‹ëŒ€ ì§•ìˆ˜</button>
  </div>

  <div id="stats" style="display:none">
    <label for="monthSelectStats">ğŸ“… ì›” ì„ íƒ: </label>
    <select id="monthSelectStats" onchange="renderStatsTable()">
      <option value="2025-01">2025-01</option>
      <option value="2025-02">2025-02</option>
      <option value="2025-03">2025-03</option>
      <option value="2025-04">2025-04</option>
      <option value="2025-05" selected>2025-05</option>
    </select>
    <h1>ğŸ“Š ê°œì¸ë³„ ì‹ì‚¬ í†µê³„</h1>
    <table>
      <thead id="statsHead"></thead>
      <tbody id="statsBody"></tbody>
    </table>
  </div>

  <div id="expenses" style="display:none">
    <label for="monthSelect">ğŸ“… ì›” ì„ íƒ: </label>
    <select id="monthSelect" onchange="renderExpenseTable()">
      <option value="2025-01">2025-01</option>
      <option value="2025-02">2025-02</option>
      <option value="2025-03">2025-03</option>
      <option value="2025-04">2025-04</option>
      <option value="2025-05" selected>2025-05</option>
    </select>
    <h1>ğŸ“‹ ì‹ë‹¹ìš´ì˜ë¹„ê´€ë¦¬</h1>
    <table>
      <thead>
        <tr><th>ì›”</th><th>ìˆ˜ì…ì•¡</th><th>ì§€ì¶œì•¡</th><th>ì°¨ì•¡</th></tr>
      </thead>
      <tbody id="expenseTableBody"></tbody>
    </table>
    <h2 id="nextMonthEstimate"></h2>
  </div>

  <div id="charges" style="display:none">
    <label for="monthSelectCharges">ğŸ“… ì›” ì„ íƒ: </label>
    <select id="monthSelectCharges" onchange="renderChargeTable()">
      <option value="2025-01">2025-01</option>
      <option value="2025-02">2025-02</option>
      <option value="2025-03">2025-03</option>
      <option value="2025-04">2025-04</option>
      <option value="2025-05" selected>2025-05</option>
    </select>
    <h1>ğŸ’° ì‹ëŒ€ ì§•ìˆ˜</h1>
    <table>
      <thead>
        <tr><th>ì´ë¦„</th><th>ì‹ì‚¬íšŸìˆ˜</th><th>ê¸°ë³¸ ì‹ë¹„</th><th>ì¶”ê°€ ì‹ë¹„</th><th>ì´ì•¡</th></tr>
      </thead>
      <tbody id="chargeTableBody"></tbody>
    </table>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD5TK7QNHXvQsjKNQ7136SxhP_lJ9PdbsM",
      authDomain: "lunch-20bb8.firebaseapp.com",
      databaseURL: "https://lunch-20bb8-default-rtdb.firebaseio.com",
      projectId: "lunch-20bb8",
      storageBucket: "lunch-20bb8.appspot.com",
      messagingSenderId: "218925939220",
      appId: "1:218925939220:web:4b8940a954f05bfb4a0501"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const employees = ["ì´ì˜ì¼", "ê¹€ì •ì´", "ì´í˜„ìŠ¹", "ê¹€ì„±ë™", "ê¹€ë¯¸ì§€", "ë°•ë³‘ì‚¼", "ê¹€í•˜ì€", "í•œìˆ˜ì§„", "ì„ì •ì•„", "ê¹€í˜œê²½", "ì‹¬ê·œí•œ", "ì—°ê²½ìˆœ", "ì„ê²½ìˆœ", "ì´ë¯¼í•˜", "ì´ìœ ë¯¸", "ì´ìœ¤í¬", "ìµœìŠ¹í•„", "í™ì„ ì£¼", "ì„ìˆœì˜¥", "ì •ë¯¸ê²½", "ì´ì°½ë¡€", "ì„ì£¼ì—°", "ê¹€ë¬¸ì •", "ê¹€ë¯¸ì˜", "ì‹¬ì¥ì‹", "ì†ì˜ë³µ", "ì†ì˜ë¶€", "ê°•ì„±í•„", "ê¹€ì •ê·¼", "ì˜¤í™”ì§„"];

    const incomeMap = {
      "2025-01": 265000,
      "2025-02": 1170000,
      "2025-03": 1170000,
      "2025-04": 1905000
    };
    const expenseMap = {
      "2025-01": 404650,
      "2025-02": 1212510,
      "2025-03": 1171310,
      "2025-04": 1656100
    };

    function renderStatsTable() {
      const selectedMonth = document.getElementById("monthSelectStats")?.value || "2025-05";
      const tbody = document.getElementById("statsBody");
      const thead = document.getElementById("statsHead");
      db.ref("mealLogs").once("value").then(snapshot => {
        const data = snapshot.val() || {};
        const dateSet = new Set();

        for (const name of employees) {
          if (!data[name]) continue;
          for (const date in data[name]) {
            if (date.startsWith(selectedMonth)) {
              dateSet.add(date);
            }
          }
        }

        const sortedDates = Array.from(dateSet).sort();
        thead.innerHTML = `<tr><th>ì´ë¦„</th>${sortedDates.map(d => `<th>${d.slice(5)}</th>`).join('')}<th>ì´í•©</th></tr>`;

        const rows = employees.map(name => {
          let count = 0;
          const cells = sortedDates.map(date => {
            const mark = data?.[name]?.[date] || '';
            if (mark === 'O') count++;
            return `<td>${mark}</td>`;
          }).join('');
          return `<tr><td>${name}</td>${cells}<td class="highlight">${count}</td></tr>`;
        });

        tbody.innerHTML = rows.join('');
      });
    }

    function renderChargeTable() {
      const selectedMonth = document.getElementById("monthSelectCharges")?.value || "2025-05";
      const tbody = document.getElementById("chargeTableBody");
      db.ref("mealLogs").once("value").then(snapshot => {
        const data = snapshot.val() || {};
        const rows = employees.map(name => {
          let count = 0;
          for (const date in data[name]) {
            if (date.startsWith(selectedMonth) && data[name][date] === 'O') count++;
          }
          const basic = 50000;
          const extra = Math.max(0, count - 10) * 5000;
          const total = basic + extra;
          return `<tr><td>${name}</td><td>${count}</td><td>${basic.toLocaleString()}</td><td>${extra.toLocaleString()}</td><td>${total.toLocaleString()}</td></tr>`;
        });
        tbody.innerHTML = rows.join('');
      });
    }

    function renderExpenseTable() {
      const selectedMonth = document.getElementById("monthSelect")?.value || "2025-05";
      const tbody = document.getElementById("expenseTableBody");
      tbody.innerHTML = Object.keys(incomeMap).map(month => {
        const income = incomeMap[month] || 0;
        const expense = expenseMap[month] || 0;
        const diff = income - expense;
        return `<tr><td>${month}</td><td>${income.toLocaleString()}</td><td>${expense.toLocaleString()}</td><td>${diff.toLocaleString()}</td></tr>`;
      }).join('');

      const weekdayAverages = {
        summer: { 'ì›”': 8.49, 'í™”': 17.33, 'ìˆ˜': 17.94, 'ëª©': 18.95, 'ê¸ˆ': 15.66 },
        winter: { 'ì›”': 7.28, 'í™”': 13.83, 'ìˆ˜': 14.81, 'ëª©': 15.26, 'ê¸ˆ': 13.5 }
      };

      const publicHolidays = ["2025-05-05", "2025-05-06"];
      const weekDayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      const [year, month] = selectedMonth.split('-').map(Number);
      const daysInMonth = new Date(year, month, 0).getDate();
      const counts = { 'ì›”': 0, 'í™”': 0, 'ìˆ˜': 0, 'ëª©': 0, 'ê¸ˆ': 0 };

      for (let d = 1; d <= daysInMonth; d++) {
        const dayStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const dateObj = new Date(dayStr);
        const weekday = weekDayNames[dateObj.getDay()];
        if (counts[weekday] !== undefined && !publicHolidays.includes(dayStr)) {
          counts[weekday]++;
        }
      }

      const season = (month >= 4 && month <= 9) ? 'summer' : 'winter';
      let estimate = 0;
      for (const day in counts) {
        const avg = weekdayAverages[season][day];
        estimate += avg * counts[day] * 4500;
      }
      document.getElementById("nextMonthEstimate").textContent = `${selectedMonth} ì˜ˆìƒ ì§€ì¶œì•¡: ${Math.round(estimate).toLocaleString()}ì›`;
    }

    document.getElementById("btnStats").onclick = () => {
      document.getElementById("stats").style.display = "block";
      document.getElementById("expenses").style.display = "none";
      document.getElementById("charges").style.display = "none";
      renderStatsTable();
    };
    document.getElementById("btnExpenses").onclick = () => {
      document.getElementById("stats").style.display = "none";
      document.getElementById("expenses").style.display = "block";
      document.getElementById("charges").style.display = "none";
      renderExpenseTable();
    };
    document.getElementById("btnCharges").onclick = () => {
      document.getElementById("stats").style.display = "none";
      document.getElementById("expenses").style.display = "none";
      document.getElementById("charges").style.display = "block";
      renderChargeTable();
    };
  </script>
</body>
</html>
