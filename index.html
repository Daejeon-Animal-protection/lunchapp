<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Lunch Check</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { font-family: sans-serif; background: #f4f4f4; padding: 20px; text-align: center; }
    button { margin: 4px; padding: 8px 12px; }
    .section { display: none; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 12px; }
    th { background-color: #eee; }
    .highlight { font-weight: bold; }
    .small-btn { font-size: 10px; margin-left: 4px; }
    .expense-input { width: 80px; }
    #estimateDetails { display: none; text-align: left; max-width: 600px; margin: 10px auto; font-size: 12px; }
  </style>
</head>
<body>
  <!-- ë©”ë‰´ ë²„íŠ¼ -->
  <div>
    <button id="btnStats">ğŸ“Š ê°œì¸ë³„ ì‹ì‚¬ í†µê³„</button>
    <button id="btnExpenses">ğŸ“‹ ì‹ë‹¹ìš´ì˜ë¹„ê´€ë¦¬</button>
    <button id="btnCharges">ğŸ’° ì‹ëŒ€ ì§•ìˆ˜</button>
    <button id="btnSettings">âš™ï¸ ì„¤ì •</button>
  </div>

  <!-- ê°œì¸ë³„ ì‹ì‚¬ í†µê³„ ì„¹ì…˜ -->
  <div id="stats" class="section">
    <label for="monthSelectStats">ğŸ“… ì›” ì„ íƒ: </label>
    <select id="monthSelectStats" onchange="renderStatsTable()"></select>
    <h1>ğŸ“Š ê°œì¸ë³„ ì‹ì‚¬ í†µê³„</h1>
    <table>
      <thead id="statsHead"></thead>
      <tbody id="statsBody"></tbody>
    </table>
  </div>

  <!-- ì‹ë‹¹ìš´ì˜ë¹„ê´€ë¦¬ ì„¹ì…˜ -->
  <div id="expenses" class="section">
    <label>ğŸ“… ì›” ì„ íƒ: 
      <select id="monthSelect" onchange="renderExpenseTable()"></select>
    </label>
    <h1>ğŸ“‹ ì‹ë‹¹ìš´ì˜ë¹„ê´€ë¦¬</h1>
    <button id="addExpenseRow">â• í–‰ ì¶”ê°€</button>
    <table>
      <thead><tr><th>ì›”</th><th>ìˆ˜ì…ì•¡</th><th>ì§€ì¶œì•¡</th><th>ì°¨ì•¡</th><th>ì‚­ì œ</th></tr></thead>
      <tbody id="expenseTableBody"></tbody>
    </table>
    <h2 id="nextMonthEstimate"></h2>
    <button id="toggleEstimate">ìì„¸íˆ ë³´ê¸°</button>
    <div id="estimateDetails"></div>
  </div>

  <!-- ì‹ëŒ€ ì§•ìˆ˜ ì„¹ì…˜ -->
  <div id="charges" class="section">
    <label>ğŸ“… ì›” ì„ íƒ: <select id="monthSelectCharges" onchange="renderChargeTable()"></select></label>
    <h1>ğŸ’° ì‹ëŒ€ ì§•ìˆ˜</h1>
    <table>
      <thead><tr><th>ì´ë¦„</th><th>ì‹ì‚¬íšŸìˆ˜</th><th>ê¸°ë³¸ ì‹ë¹„</th><th>ì¶”ê°€ ì‹ë¹„</th><th>ì´ì•¡</th></tr></thead>
      <tbody id="chargeTableBody"></tbody>
    </table>
  </div>

  <!-- ì„¤ì • ì„¹ì…˜ -->
  <div id="settings" class="section">
    <h1>âš™ï¸ ì„¤ì •</h1>
    <button id="btnEmployees">ğŸ‘¥ ì§ì›ëª©ë¡</button>
    <div id="employeeSettings" style="display:none;">
      <input id="newEmployee" placeholder="ì§ì›ì´ë¦„ ì…ë ¥"/>
      <button id="addEmployeeBtn">â• ì¶”ê°€</button>
      <ul id="employeeList"></ul>
    </div>
  </div>

<script>
  // Firebase ì´ˆê¸°í™”
  firebase.initializeApp({
    apiKey: "AIzaSyD5TK7QNHXvQsjKNQ7136SxhP_lJ9PdbsM",
    authDomain: "lunch-20bb8.firebaseapp.com",
    databaseURL: "https://lunch-20bb8-default-rtdb.firebaseio.com",
    projectId: "lunch-20bb8"
  });
  const db = firebase.database();

  let employees = [];
  const regularList = ["ì´ì˜ì¼","ì´í˜„ìŠ¹","ê¹€ì„±ë™","ë°•ë³‘ì‚¼","ê¹€í•˜ì€","ê¹€ë¯¸ì§€","í•œìˆ˜ì§„","ê¹€í˜œê²½","ì„ì •ì•„"];
  const expenseData = [
    { month:'2025-01', income:265000, expense:404650 },
    { month:'2025-02', income:1170000, expense:1212510 },
    { month:'2025-03', income:1170000, expense:1171310 },
    { month:'2025-04', income:1905000, expense:1656100 }
  ];

  function showSection(id) {
    document.querySelectorAll('.section').forEach(sec => sec.style.display = 'none');
    document.getElementById(id).style.display = 'block';
  }

  function initMonthOptions() {
    const now = new Date();
    const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    const months = ['2025-01','2025-02','2025-03','2025-04','2025-05'];
    ['monthSelectStats','monthSelect','monthSelectCharges'].forEach(id => {
      const sel = document.getElementById(id);
      sel.innerHTML = '';
      months.forEach(val => { const opt = document.createElement('option'); opt.value = val; opt.textContent = val; sel.appendChild(opt); });
      sel.value = months.includes(ym) ? ym : months[months.length-1];
    });
  }

  function renderEmployeeList() {
    const ul = document.getElementById("employeeList"); ul.innerHTML = '';
    if (!employees.length) { ul.innerHTML = '<li style="color:gray">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</li>'; return; }
    const regGroup = document.createElement('li'); regGroup.innerHTML = '<strong>ì¼ë°˜ì§</strong>';
    const conGroup = document.createElement('li'); conGroup.innerHTML = '<strong>ê¸°ê°„ì œ</strong>';
    function addRow(name, idx, group) {
      const li = document.createElement('li');
      const input = document.createElement('input'); input.type='text'; input.value=name; input.disabled=true;
      const edit = document.createElement('button'); edit.textContent='âœï¸';
      const save = document.createElement('button'); save.textContent='ğŸ“‚'; save.style.display='none';
      const up = document.createElement('button'); up.textContent='ğŸ”¼';
      const down = document.createElement('button'); down.textContent='ğŸ”½';
      const move = document.createElement('button'); move.textContent= group==='regular'? 'â¡ï¸ ê¸°ê°„ì œ':'â¬…ï¸ ì¼ë°˜ì§';
      edit.onclick = () => { input.disabled=false; input.focus(); edit.style.display='none'; save.style.display='inline-block'; };
      save.onclick = () => { const nv=input.value.trim(); nv&&nv!==name&&(employees[idx]=nv, db.ref("employees").set(employees), renderEmployeeList()); };
      const del = document.createElement('button'); del.textContent='âŒ'; del.onclick=() => { employees.splice(idx,1); db.ref("employees").set(employees); renderEmployeeList(); };
      move.onclick = () => { regularList=regularList.filter(n=>n!==name); group==='contract'&&regularList.push(name); db.ref("employees").set(employees); renderEmployeeList(); };
      up.onclick = () => { if(idx>0){ [employees[idx-1],employees[idx]]=[employees[idx],employees[idx-1]]; db.ref("employees").set(employees); renderEmployeeList(); }};
      down.onclick = () => { if(idx<employees.length-1){ [employees[idx],employees[idx+1]]=[employees[idx+1],employees[idx]]; db.ref("employees").set(employees); renderEmployeeList(); }};
      [input, edit, save, del, up, down, move].forEach(el=>li.appendChild(el));
      group==='regular'? regGroup.appendChild(li): conGroup.appendChild(li);
    }
    employees.forEach((n,i)=> addRow(n,i, regularList.includes(n)? 'regular':'contract'));
    ul.appendChild(regGroup); ul.appendChild(conGroup);}
  

  function addEmployee() {
    const input = document.getElementById('newEmployee');
    const name = input.value.trim();
    if (name && !employees.includes(name)) {
      employees.push(name);
      db.ref('employees').set(employees);
      input.value = '';
      renderEmployeeList();
    }
  }

  function renderStatsTable() {
    const sel = document.getElementById('monthSelectStats').value;
    const thead = document.getElementById('statsHead');
    const tbody = document.getElementById('statsBody');
    db.ref('mealLogs').once('value').then(snap => {
      const data = snap.val() || {};
      const dates = new Set();
      employees.forEach(n => { if (data[n]) Object.keys(data[n]).forEach(d => { if (d.startsWith(sel)) dates.add(d); }); });
      const sd = Array.from(dates).sort();
      thead.innerHTML = `<tr><th>ì´ë¦„</th>${sd.map(d => `<th>${d.slice(5)}</th>`).join('')}<th>ì´í•©</th></tr>`;
      tbody.innerHTML = employees.map(n => {
        let cnt = 0;
        const cells = sd.map(d => { const v = data[n]?.[d] || ''; if (v === 'O') cnt++; return `<td>${v}</td>`; }).join('');
        return `<tr><td>${n}</td>${cells}<td class="highlight">${cnt}</td></tr>`;
      }).join('');
    });
  }

  function renderExpenseTable() {
    const tbody = document.getElementById('expenseTableBody'); tbody.innerHTML = '';
    expenseData.forEach((it, i) => {
      const diff = it.income - it.expense;
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td>${it.month}</td><td>${it.income.toLocaleString()}</td>` +
        `<td><span class="expense-value">${it.expense.toLocaleString()}</span> <button class="small-btn edit-expense">âœï¸</button></td>` +
        `<td class="highlight">${diff.toLocaleString()}</td><td><button class="small-btn delete-expense">âŒ</button></td>`;
      tr.querySelector('.edit-expense').onclick = () => {
        const span = tr.querySelector('.expense-value');
        const oldVal = span.textContent.replace(/,/g, '');
        const input = document.createElement('input'); input.type = 'number'; input.value = oldVal; input.classList.add('expense-input');
        span.replaceWith(input); input.focus();
        input.onblur = () => { it.expense = parseInt(input.value) || 0; renderExpenseTable(); };
      };
      tr.querySelector('.delete-expense').onclick = () => { expenseData.splice(i, 1); renderExpenseTable(); };
      tbody.appendChild(tr);
    });
    updateEstimate();
  }

  function renderChargeTable() {
    const sel = document.getElementById('monthSelectCharges').value;
    const tbody = document.getElementById('chargeTableBody'); tbody.innerHTML = '';
    db.ref('mealLogs').once('value').then(snap => {
      const data = snap.val() || {};
      employees.forEach(n => {
        let cnt = 0;
        Object.entries(data[n] || {}).forEach(([d, v]) => { if (d.startsWith(sel) && v === 'O') cnt++; });
        const basic = 50000, extra = Math.max(0, cnt - 10) * 5000, total = basic + extra;
        tbody.innerHTML += `<tr><td>${n}</td><td>${cnt}</td><td>${basic.toLocaleString()}</td><td>${extra.toLocaleString()}</td><td>${total.toLocaleString()}</td></tr>`;
      });
    });
  }

  function updateEstimate() {
    const sel = document.getElementById('monthSelect').value;
    const [y, m] = sel.split('-').map(Number);
    const days = new Date(y, m, 0).getDate();
    const wk = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    const cnt = { 'ì›”':0, 'í™”':0, 'ìˆ˜':0, 'ëª©':0, 'ê¸ˆ':0 };
    const hol = ['2025-05-05','2025-05-06'];
    for (let d = 1; d <= days; d++) {
      const ds = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const w = wk[new Date(ds).getDay()];
      if (cnt[w] !== undefined && !hol.includes(ds)) cnt[w]++;
    }
    const avg = { summer:{'ì›”':8.49,'í™”':17.33,'ìˆ˜':17.94,'ëª©':18.95,'ê¸ˆ':15.66}, winter:{'ì›”':7.28,'í™”':13.83,'ìˆ˜':14.81,'ëª©':15.26,'ê¸ˆ':13.5} };
    const season = (m >= 4 && m <= 9) ? 'summer' : 'winter';
    const cost = 4500;
    let est = 0;
    Object.entries(cnt).forEach(([d, c]) => { est += avg[season][d] * c * cost; });
    document.getElementById('nextMonthEstimate').textContent = `${sel} ì˜ˆìƒ ì§€ì¶œì•¡: ${Math.round(est).toLocaleString()}ì›`;
    const expr = Object.entries(cnt).map(([d, c]) => `(${d}:${c}ì¼Ã—${avg[season][d]}ëª…Ã—${cost}ì›)`).join(' + ');
    document.getElementById('estimateDetails').innerHTML = `<strong>ê³„ì‚° ê·¼ê±°:</strong><br><em>í‰ê· Ã—í‰ì¼Ã—ì¸ë‹¹ ${cost.toLocaleString()}ì›</em><br><strong>ê³„ì‚°ì‹:</strong>${expr} = ${Math.round(est).toLocaleString()}ì›`;
  }

  document.addEventListener('DOMContentLoaded', () => {
    initMonthOptions();
    db.ref('employees').on('value', snap => { employees = snap.val() || []; renderEmployeeList(); });
    document.getElementById('btnStats').onclick = () => { showSection('stats'); renderStatsTable(); };
    document.getElementById('btnExpenses').onclick = () => { showSection('expenses'); renderExpenseTable(); };
    document.getElementById('btnCharges').onclick = () => { showSection('charges'); renderChargeTable(); };
    document.getElementById('btnSettings').onclick = () => { showSection('settings'); };
    document.getElementById('btnEmployees').onclick = () => { const es = document.getElementById('employeeSettings'); es.style.display = es.style.display==='none'?'block':'none'; };
    document.getElementById('addEmployeeBtn').onclick = addEmployee;
    document.getElementById('addExpenseRow').onclick = () => { const m = document.getElementById('monthSelect').value; if (!expenseData.some(e=>e.month===m)) expenseData.push({month:m, income:getChargeTotal(), expense:0}); renderExpenseTable(); };
    document.getElementById('toggleEstimate').onclick = () => { const d = document.getElementById('estimateDetails'); d.style.display = d.style.display==='none'?'block':'none'; };
    showSection('stats');
  });
</script>
</body>
</html>
