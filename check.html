<!DOCTYPE html>
<html lang="ko" style="width:100%; height:100%; margin:0; padding:0;">
<head>
  <meta charset="UTF-8" />
  <title>ì ì‹¬ ì‹ì‚¬ ì²´í¬</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    html, body { width:100%; height:100%; margin:0; padding:0; }
    body { font-family: 'Segoe UI', sans-serif; background:#f2f2f2; display:flex; flex-direction:column; font-size:18px; }
    h2 { margin:12px 0; font-size:28px; text-align:center; }
    #todayStat { font-size:18px; color:#333; text-align:center; margin-bottom:12px; }
    #main, #check { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; overflow:hidden; }
    .button { padding:10px 20px; margin:8px; font-size:16px; cursor:pointer; border:none; border-radius:8px; background-color:#2196F3; color:white; }
    .button:hover { background-color:#1976D2; }
    .ox-btn { padding:8px 14px; margin:0 6px; border-radius:6px; border:none; font-size:18px; background-color:#e0e0e0; cursor:pointer; }
    .ox-btn.selected { background-color:#4caf50; color:white; }
    .grid { width:95%; display:grid; grid-template-columns:repeat(auto-fill, minmax(160px,1fr)); gap:14px; justify-items:center; }
    .name-btn { width:100%; background:#fff; border:1px solid #aaa; border-radius:12px; padding:14px; cursor:pointer; font-size:18px; }
    .group-label { font-weight:bold; margin-top:24px; font-size:20px; color:#555; }
    #dates { width:95%; flex:1; overflow:auto; text-align:center; }
    .date-row { margin:8px 0; display:flex; justify-content:center; align-items:center; font-size:18px; }
    .today-highlight { border:2px solid #f44336; border-radius:8px; padding:6px; background-color:#ffecec; }
  </style>
</head>
<body>
  <h2>ğŸ± ì ì‹¬ ì‹ì‚¬ ì²´í¬ - ì˜¤ëŠ˜: <span id="todayDate"></span></h2>
  <div id="todayStat"></div>
  <div id="main">
    <div class="group-label">ğŸ“Œ ì¼ë°˜ì§</div>
    <div class="grid" id="regular"></div>
    <div class="group-label">ğŸ“Œ ê¸°ê°„ì œ</div>
    <div class="grid" id="contract"></div>
  </div>
  <div id="check" style="display:none; width:100%; flex-direction:column; align-items:center;">
    <h2 id="selectedName"></h2>
    <select id="monthSelect" style="margin-bottom:12px; font-size:18px; padding:6px 10px;"></select>
    <div>
      <button class="button" onclick="saveMealLog()">âœ… ì €ì¥</button>
      <button class="button" onclick="goBack()">â¬…ï¸ ë’¤ë¡œ</button>
    </div>
    <div id="dates"></div>
  </div>
  <script>
    // Firebase ì´ˆê¸°í™”
    const firebaseConfig = {
      apiKey: "AIzaSyD5TK7QNHXvQsjKNQ7136SxhP_lJ9PdbsM",
      authDomain: "lunch-20bb8.firebaseapp.com",
      databaseURL: "https://lunch-20bb8-default-rtdb.firebaseio.com",
      projectId: "lunch-20bb8",
      storageBucket: "lunch-20bb8.appspot.com",
      messagingSenderId: "218925939220",
      appId: "1:218925939220:web:4b8940a954f05bfb4a0501"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ì „ì—­ ë³€ìˆ˜
    let currentName = '';
    let values = {};

    // ì§ì› ëª©ë¡
    const names = ["ì´ì˜ì¼","ê¹€ì •ì´","ì´í˜„ìŠ¹","ê¹€ì„±ë™","ê¹€ë¯¸ì§€","ë°•ë³‘ì‚¼","ê¹€í•˜ì€","í•œìˆ˜ì§„","ì„ì •ì•„","ê¹€í˜œê²½",
                   "ì‹¬ê·œí•œ","ì—°ê²½ìˆœ","ì„ê²½ìˆœ","ì´ë¯¼í•˜","ì´ìœ ë¯¸","ì´ìœ¤í¬","ìµœìŠ¹í•„","í™ì„ ì£¼","ì„ìˆœì˜¥","ì •ë¯¸ê²½",
                   "ì´ì°½ë¡€","ì„ì£¼ì—°","ê¹€ë¬¸ì •","ê¹€ë¯¸ì˜","ì‹¬ì¥ì‹","ì†ì˜ë³µ","ì†ì˜ë¶€","ê°•ì„±í•„","ê¹€ì •ê·¼","ì˜¤í™”ì§„"];
    const regular = names.slice(0,10);
    const contract = names.slice(10);

    // ì œì™¸í•  ì•¼ê°„ì¡° ëª©ë¡
    const nightOffList = ["ì—°ê²½ìˆœ","ì„ê²½ìˆœ","ìµœìŠ¹í•„","í™ì„ ì£¼","ì„ìˆœì˜¥","ì´ì°½ë¡€","ì„ì£¼ì—°","ê¹€ë¯¸ì˜",
                          "ì‹¬ì¥ì‹","ì†ì˜ë³µ","ì†ì˜ë¶€","ê°•ì„±í•„","ì˜¤í™”ì§„"];

    // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
    const today = new Date(); today.setHours(today.getHours()+9);
    const thisYear = today.getFullYear(), thisMonth = today.getMonth();
    const todayISO = today.toISOString().split('T')[0];
    document.getElementById('todayDate').textContent = todayISO;

    // ë°ì´í„° ë¡œë”© Promise
    const leaveDatesMap = {}, nightShiftMap = {};
    const leavePromise = db.ref('leave').once('value').then(snap => Object.assign(leaveDatesMap, snap.val()||{}));
    const nightPromise = db.ref('nightShift').once('value').then(snap => Object.assign(nightShiftMap, snap.val()||{}));

    // ì´ˆê¸° UI ë Œë”ë§
    Promise.all([leavePromise, nightPromise]).then(() => {
      regular.forEach(name => {
        const btn = document.createElement('button'); btn.className='name-btn'; btn.textContent=name; btn.onclick=()=>openCheck(name);
        document.getElementById('regular').appendChild(btn);
      });
      contract.forEach(name => {
        const btn = document.createElement('button'); btn.className='name-btn'; btn.textContent=name; btn.onclick=()=>openCheck(name);
        document.getElementById('contract').appendChild(btn);
      });
      renderTodayStat();
    }).catch(err => console.error('ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì—ëŸ¬:', err));

    // ì˜¤ëŠ˜ í†µê³„ ë Œë”
    function renderTodayStat() {
      db.ref('mealLogs').once('value').then(snap => {
        const data = snap.val()||{};
        let count = 0;
        const isMon = new Date(todayISO).getDay()===1;
        names.forEach(n => {
          if (isMon && contract.includes(n)) return;
           const v = data[n]?.[todayISO];
      if (v !== 'X') count++;
        });
        document.getElementById('todayStat').textContent = `âœ… ì˜¤ëŠ˜ ì‹ì‚¬í•˜ëŠ” ì¸ì›: ${count}ëª…`;
      }).catch(err => console.error('renderTodayStat error:', err));
    }

    // ê³µíœ´ì¼ API í˜¸ì¶œ
    async function getKoreanHolidays(y, m) {
      const rawKey = 'dtZOAdfRz5FEy2NGFBIEaHoQhfimWGWodsA2Wzcr+eSSdv1nDcyXk9REdGCzZuZPp32hkYvNFgHJJBeOhQ6H0g==';
      const serviceKey = encodeURIComponent(rawKey);
      const mm = String(m).padStart(2, '0');
      const url = `https://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo`
        + `?ServiceKey=${serviceKey}`
        + `&solYear=${y}`
        + `&solMonth=${mm}`
        + `&numOfRows=31&pageNo=1&_type=json`;
      console.log('ğŸŒ Fetching holiday URL:', url);
      const res = await fetch(url);
      const text = await res.text();
      console.log('ğŸ“„ Raw holiday response:', text);
      try {
        const json = JSON.parse(text);
        const items = json.response.body.items?.item || [];
        return items.map(i => {
          const s = i.locdate.toString();
          return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
        });
      } catch (error) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(text, 'application/xml');
        const xmlItems = xmlDoc.getElementsByTagName('item');
        return Array.from(xmlItems).map(item => {
          const s = item.getElementsByTagName('locdate')[0].textContent;
          return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
        });
      }
    }

    // ì›” ì˜µì…˜ ë Œë”
    function renderMonthOptions() {
      const sel = document.getElementById('monthSelect'); sel.innerHTML = '';
      for (let m = 0; m < 12; m++) {
        const opt = document.createElement('option'); opt.value = m; opt.textContent = `${m+1}ì›”`;
        if (m === thisMonth) opt.selected = true;
        sel.appendChild(opt);
      }
      sel.onchange = () => renderDates(currentName, Number(sel.value));
    }

    // ìƒì„¸ ë·° ì˜¤í”ˆ
    function openCheck(name) {
      currentName = name;
      document.getElementById('main').style.display = 'none';
      document.getElementById('check').style.display = 'flex';
      renderMonthOptions();
      renderDates(name, thisMonth);
    }
    
async function generateWorkdaysForMonth(y, m) {
    const holidays = await getKoreanHolidays(y, m + 1);
      console.log(`ğŸ“… ${y}-${String(m+1).padStart(2,'0')} ê³µíœ´ì¼:`, holidays);
    const days = [];
    const total = new Date(y, m + 1, 0).getDate();
    const mm = String(m + 1).padStart(2, '0');

    for (let d = 1; d <= total; d++) {
      const iso = `${y}-${mm}-${String(d).padStart(2, '0')}`;
      const dow = new Date(iso).getDay();
      if (dow < 1 || dow > 5) continue;        // ì£¼ë§ ì œì™¸
      if (holidays.includes(iso)) continue;     // ê³µíœ´ì¼ ì œì™¸
      days.push(iso);
    }
    return days;
  }

    // ë‚ ì§œë³„ O/X ë Œë”
  async function renderDates(name, month) {
  console.log('â–¶ renderDates í˜¸ì¶œ:', name, month);

  try {
    // 1) selectedName ìš”ì†Œ ì²´í¬
    const selEl = document.getElementById('selectedName');
    console.log('  â–¶ #selectedName:', selEl);
    if (!selEl) throw new Error('#selectedName ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

    selEl.textContent = `${name} - ${thisYear}ë…„ ${month+1}ì›”`;

    // 2) dates ì»¨í…Œì´ë„ˆ ì²´í¬
    const cont = document.getElementById('dates');
    console.log('  â–¶ #dates ì»¨í…Œì´ë„ˆ:', cont);
    if (!cont) throw new Error('#dates ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

    // 3) DBì—ì„œ ê¸°ì¡´ê°’ ê°€ì ¸ì˜¤ê¸°
    const snap = await db.ref(`mealLogs/${name}`).once('value');
    values = snap.val() || {};
    console.log('  â–¶ DBì—ì„œ ê°€ì ¸ì˜¨ values:', values);

    // 4) ë‚ ì§œ ë°°ì—´ ìƒì„±
    const days = await generateWorkdaysForMonth(thisYear, month);
    console.log('  â–¶ ìƒì„±ëœ days ë°°ì—´:', days);

    // 5) ë Œë”ë§
    cont.innerHTML = '';
    days.forEach(date => {
      if (contract.includes(name) && new Date(date).getDay() === 1)     values[date] = 'X';
if (leaveDatesMap[name] && leaveDatesMap[name][date])values[date] = 'X';
if (nightOffList.includes(name) && nightShiftMap[name]&&nightShiftMap[name][date]) values[date] = 'X';
       if (new Date(date) < new Date(todayISO) && values[date] === undefined) values[date] = 'X';
      const row = document.createElement('div');
      row.className = 'date-row';
      if (date === todayISO) row.classList.add('today-highlight');
      const lbl = document.createElement('span'); lbl.textContent = `${date}: `;
        const btnO = document.createElement('button'); btnO.textContent = 'O'; btnO.className = 'ox-btn';
        const btnX = document.createElement('button'); btnX.textContent = 'X'; btnX.className = 'ox-btn';
        if (values[date] === 'O') btnO.classList.add('selected');
        if (values[date] === 'X') btnX.classList.add('selected');
        btnO.onclick = () => { values[date] = 'O'; btnO.classList.add('selected'); btnX.classList.remove('selected'); };
        btnX.onclick = () => { values[date] = 'X'; btnX.classList.add('selected'); btnO.classList.remove('selected'); };
        row.append(lbl, btnO, btnX); 
      cont.appendChild(row);
    }); console.log('âœ… renderDates ì™„ë£Œ');
  } catch (err) {
    console.error('âŒ renderDates ì¤‘ ì—ëŸ¬:', err);
  }

    }

    function goBack() {
      document.getElementById('check').style.display = 'none';
      document.getElementById('main').style.display = 'flex';
    }

    function saveMealLog() {
      db.ref(`mealLogs/${currentName}`).update(values)
        .then(() => { alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤'); goBack(); })
        .catch(err => console.error('saveMealLog error:', err));
    }
  </script>
</body>
</html>
