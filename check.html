<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì ì‹¬ ì‹ì‚¬ ì²´í¬</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f2f2f2; text-align: center; }
    h2 { margin-top: 0; font-size: 24px; color: #333; }
    .button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; border: none; border-radius: 8px; background-color: #2196F3; color: white; }
    .button:hover { background-color: #1976D2; }
    .ox-btn { padding: 6px 12px; margin-left: 8px; border-radius: 6px; border: none; font-size: 16px; background-color: #e0e0e0; cursor: pointer; }
    .ox-btn.selected { background-color: #4caf50; color: white; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; justify-items: center; }
    .name-btn { width: 100%; background-color: #fff; border: 1px solid #aaa; border-radius: 10px; padding: 10px; cursor: pointer; font-size: 15px; }
    .group-label { font-weight: bold; margin-top: 30px; font-size: 18px; color: #555; }
    #dates { max-height: 70vh; overflow-y: auto; padding-bottom: 20px; }
    .today-highlight { border: 2px solid #f44336; border-radius: 8px; padding: 4px; background-color: #ffecec; }
  </style>
</head>
<body>
  <h2>ğŸ± ì ì‹¬ ì‹ì‚¬ ì²´í¬ - ì˜¤ëŠ˜: <span id="todayDate"></span></h2>
  <div id="todayStat" style="font-size:16px; color:#333; margin:10px 0;"></div>
  <div id="main">
    <div class="group-label">ğŸ“Œ ì¼ë°˜ì§</div>
    <div class="grid" id="regular"></div>
    <div class="group-label">ğŸ“Œ ê¸°ê°„ì œ</div>
    <div class="grid" id="contract"></div>
  </div>
  <div id="check" style="display:none">
    <h2 id="selectedName"></h2>
    <select id="monthSelect"></select>
    <div id="dates"></div>
    <button class="button" onclick="saveMealLog()">âœ… ì €ì¥</button>
    <button class="button" onclick="goBack()">â¬…ï¸ ë’¤ë¡œ</button>
  </div>

  <script>
    // ì „ì—­ ë³€ìˆ˜
    let currentName = '';
    let values = {};

    // Firebase ì´ˆê¸°í™”
    const firebaseConfig = {
      apiKey: "AIzaSyD5TK7QNHXvQsjKNQ7136SxhP_lJ9PdbsM",
      authDomain: "lunch-20bb8.firebaseapp.com",
      projectId: "lunch-20bb8",
      storageBucket: "lunch-20bb8.appspot.com",
      messagingSenderId: "218925939220",
      appId: "1:218925939220:web:4b8940a954f05bfb4a0501"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ì§ì› ëª©ë¡
    const names = [
      "ì´ì˜ì¼","ê¹€ì •ì´","ì´í˜„ìŠ¹","ê¹€ì„±ë™","ê¹€ë¯¸ì§€","ë°•ë³‘ì‚¼","ê¹€í•˜ì€","í•œìˆ˜ì§„","ì„ì •ì•„",
      "ê¹€í˜œê²½","ì‹¬ê·œí•œ","ì—°ê²½ìˆœ","ì„ê²½ìˆœ","ì´ë¯¼í•˜","ì´ìœ ë¯¸","ì´ìœ¤í¬","ìµœìŠ¹í•„","í™ì„ ì£¼",
      "ì„ìˆœì˜¥","ì •ë¯¸ê²½","ì´ì°½ë¡€","ì„ì£¼ì—°","ê¹€ë¬¸ì •","ê¹€ë¯¸ì˜","ì‹¬ì¥ì‹","ì†ì˜ë³µ","ì†ì˜ë¶€",
      "ê°•ì„±í•„","ê¹€ì •ê·¼","ì˜¤í™”ì§„"
    ];
    const regular = names.slice(0, 10);
    const contract = names.slice(10);

    // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
    const today = new Date();
    today.setHours(today.getHours() + 9);
    const thisYear = today.getFullYear();
    const thisMonth = today.getMonth();
    const todayISO = today.toISOString().split('T')[0];
    document.getElementById('todayDate').textContent = todayISO;

    // ì˜¤ëŠ˜ ì‹ì‚¬í•œ ì¸ì› í†µê³„ ì¶œë ¥
    function renderTodayStat() {
      db.ref('mealLogs').once('value').then(snapshot => {
        const data = snapshot.val() || {};
        let count = 0;
        const isMonday = new Date(todayISO).getDay() === 1;
        names.forEach(name => {
          if (isMonday && contract.includes(name)) return;
          if (data[name] && data[name][todayISO] === 'O') count++;
        });
        document.getElementById('todayStat').textContent = `âœ… ì˜¤ëŠ˜ ì‹ì‚¬í•˜ëŠ” ì¸ì›: ${count}ëª…`;
      });
    }

    // ê³µíœ´ì¼ (í•˜ë“œì½”ë”©)
    const holidays = [
      '2025-05-05', // ì–´ë¦°ì´ë‚ 
      '2025-05-06', // ëŒ€ì²´ê³µíœ´ì¼
      '2025-06-03', // ì„ê°€íƒ„ì‹ ì¼ (íœ´ì¼)
      '2025-06-06'  // í˜„ì¶©ì¼
    ];
    function isHoliday(dateStr) { return holidays.includes(dateStr); }

    function generateWorkdaysForMonth(year, month) {
      const days = [];
      const total = new Date(year, month + 1, 0).getDate();
      const mm = String(month + 1).padStart(2, '0');
      for (let d = 1; d <= total; d++) {
        const iso = `${year}-${mm}-${String(d).padStart(2,'0')}`;
        const dow = new Date(iso).getDay();
        if (dow >= 1 && dow <= 5 && !isHoliday(iso)) days.push(iso);
      }
      return days;
    }

    function renderMonthOptions() {
      const sel = document.getElementById('monthSelect'); sel.innerHTML = '';
      for (let m=0; m<12; m++) {
        const opt = document.createElement('option'); opt.value=m; opt.text=(m+1)+'ì›”';
        if (m===thisMonth) opt.selected=true;
        sel.appendChild(opt);
      }
      sel.onchange = ()=>renderDates(currentName, Number(sel.value));
    }

    function openCheck(name) {
      currentName = name;
      document.getElementById('main').style.display='none';
      document.getElementById('check').style.display='block';
      renderMonthOptions();
      renderDates(name, thisMonth);
    }

    function renderDates(name, month) {
      document.getElementById('selectedName').textContent = `${name} - ${thisYear}ë…„ ${month+1}ì›”`;
      const days = generateWorkdaysForMonth(thisYear, month);
      db.ref(`mealLogs/${name}`).once('value').then(snapshot => {
        values = snapshot.val()||{};
        const container = document.getElementById('dates'); container.innerHTML='';
        days.forEach(iso=>{
          const row=document.createElement('div');
          const lbl=document.createElement('span'); lbl.textContent=`${iso}: `;
          const btnO=document.createElement('button'); btnO.textContent='O'; btnO.className='ox-btn';
          const btnX=document.createElement('button'); btnX.textContent='X'; btnX.className='ox-btn';
          if(values[iso]==='O') btnO.classList.add('selected');
          if(values[iso]==='X') btnX.classList.add('selected');
          btnO.onclick=()=>{values[iso]='O';btnO.classList.add('selected');btnX.classList.remove('selected');};
          btnX.onclick=()=>{values[iso]='X';btnX.classList.add('selected');btnO.classList.remove('selected');};
          if(iso===todayISO) row.classList.add('today-highlight');
          row.append(lbl,btnO,btnX);
          container.appendChild(row);
        });
      });
    }

    function goBack(){document.getElementById('check').style.display='none';document.getElementById('main').style.display='block';}
    function saveMealLog(){db.ref(`mealLogs/${currentName}`).set(values).then(()=>{alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');goBack();});}

    // ì´ˆê¸° ë Œë”ë§
    regular.forEach(n=>{const btn=document.createElement('button');btn.className='name-btn';btn.textContent=n;btn.onclick=()=>openCheck(n);document.getElementById('regular').appendChild(btn);}  );
    contract.forEach(n=>{const btn=document.createElement('button');btn.className='name-btn';btn.textContent=n;btn.onclick=()=>openCheck(n);document.getElementById('contract').appendChild(btn);}  );

    // ì´ˆê¸° ì˜¤ëŠ˜ í†µê³„
    renderTodayStat();
  </script>
</body>
</html>
