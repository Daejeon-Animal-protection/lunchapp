<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì ì‹¬ ì‹ì‚¬ ì²´í¬</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f2f2f2; text-align: center; }
    h2 { margin-top: 0; font-size: 24px; color: #333; }
    h3 { margin-top: 0; color: #222; }
    .section { margin-top: 20px; }
    .button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; border: none; border-radius: 8px; background-color: #2196F3; color: white; }
    .button:hover { background-color: #1976D2; }
    .ox-btn { padding: 6px 12px; margin-left: 8px; border-radius: 6px; border: none; font-size: 16px; background-color: #e0e0e0; cursor: pointer; }
    .ox-btn.selected { background-color: #4caf50; color: white; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; justify-items: center; }
    .name-btn { width: 100%; background-color: #fff; border: 1px solid #aaa; border-radius: 10px; padding: 10px; cursor: pointer; font-size: 15px; transition: background-color 0.2s ease; }
    .name-btn:hover { background-color: #eee; }
    .group-label { font-weight: bold; margin-top: 30px; font-size: 18px; color: #555; }
    #dates { max-height: 70vh; overflow-y: auto; scroll-behavior: smooth; padding-bottom: 20px; }
    #dates div { margin: 6px 0; font-size: 15px; }
    .today-highlight { border: 2px solid #f44336; border-radius: 8px; padding: 4px; background-color: #ffecec; }
  </style>
</head>
<body>
  <h2>ğŸ± ì ì‹¬ ì‹ì‚¬ ì²´í¬ - ì˜¤ëŠ˜: <span id="todayDate"></span></h2>
  <div id="main">
    <div class="group-label">ğŸ“Œ ì¼ë°˜ì§</div>
    <div class="grid" id="regular"></div>
    <div class="group-label">ğŸ“Œ ê¸°ê°„ì œ</div>
    <div class="grid" id="contract"></div>
  </div>
  <div id="check" style="display:none">
    <h3 id="selectedName"></h3>
    <select id="monthSelect"></select>
    <div id="dates"></div>
    <button class="button" onclick="saveMealLog()">âœ… ì €ì¥</button>
    <button class="button" onclick="goBack()">â¬…ï¸ ë’¤ë¡œ</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD5TK7QNHXvQsjKNQ7136SxhP_lJ9PdbsM",
      authDomain: "lunch-20bb8.firebaseapp.com",
      projectId: "lunch-20bb8",
      storageBucket: "lunch-20bb8.appspot.com",
      messagingSenderId: "218925939220",
      appId: "1:218925939220:web:4b8940a954f05bfb4a0501"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const names = [
      "ì´ì˜ì¼","ê¹€ì •ì´","ì´í˜„ìŠ¹","ê¹€ì„±ë™","ê¹€ë¯¸ì§€","ë°•ë³‘ì‚¼","ê¹€í•˜ì€","í•œìˆ˜ì§„","ì„ì •ì•„",
      "ê¹€í˜œê²½","ì‹¬ê·œí•œ","ì—°ê²½ìˆœ","ì„ê²½ìˆœ","ì´ë¯¼í•˜","ì´ìœ ë¯¸","ì´ìœ¤í¬","ìµœìŠ¹í•„","í™ì„ ì£¼",
      "ì„ìˆœì˜¥","ì •ë¯¸ê²½","ì´ì°½ë¡€","ì„ì£¼ì—°","ê¹€ë¬¸ì •","ê¹€ë¯¸ì˜","ì‹¬ì¥ì‹","ì†ì˜ë³µ","ì†ì˜ë¶€",
      "ê°•ì„±í•„","ê¹€ì •ê·¼","ì˜¤í™”ì§„"
    ];

    const regular = names.slice(0, 10);
    const contract = names.slice(10);

    const today = new Date();
    today.setHours(today.getHours() + 9);
    const thisYear = today.getFullYear();
    const thisMonth = today.getMonth();
    const todayISO = today.toISOString().split('T')[0];
    document.getElementById('todayDate').textContent = todayISO;

    const isMonday = today.getDay() === 1;
    db.ref("mealLogs").once("value").then(snapshot => {
      const allData = snapshot.val() || {};
      let count = 0;
      names.forEach((name) => {
        if (isMonday && contract.includes(name)) return;
        if (allData[name] && allData[name][todayISO] === 'O') count++;
      });
      const existing = document.getElementById('todayStat');
      if (existing) existing.remove();
      const stat = document.createElement('div');
      stat.id = 'todayStat';
      stat.style.marginTop = '10px';
      stat.style.fontSize = '16px';
      stat.style.color = '#333';
      stat.textContent = `âœ… ì˜¤ëŠ˜ ì‹ì‚¬í•œ ì¸ì›: ${count}ëª…`;
      document.getElementById('main').prepend(stat);
    });

    let holidays = [];
    function fetchHolidays(callback) {
      db.ref("holidays").once("value").then(snapshot => {
        holidays = snapshot.val() || [];
        callback();
      });
    }
    function isHoliday(dateStr) {
      return holidays.includes(dateStr);
    }

    function generateWorkdaysForMonth(year, month) {
      const dates = [];
      const total = new Date(year, month + 1, 0).getDate();
      const monthStr = String(month + 1).padStart(2, '0');
      for (let d = 1; d <= total; d++) {
        const date = new Date(year, month, d);
        const dow = date.getDay();
        const iso = `${year}-${monthStr}-${String(d).padStart(2, '0')}`;
        if (dow >= 1 && dow <= 5 && !isHoliday(iso)) {
          dates.push(iso);
        }
      }
      return dates;
    }

    regular.forEach(name => {
      const btn = document.createElement('button');
      btn.className = 'name-btn';
      btn.textContent = name;
      btn.onclick = () => openCheck(name);
      document.getElementById('regular').appendChild(btn);
    });
    contract.forEach(name => {
      const btn = document.createElement('button');
      btn.className = 'name-btn';
      btn.textContent = name;
      btn.onclick = () => openCheck(name);
      document.getElementById('contract').appendChild(btn);
    });

    let currentName = "";
    let values = {};
    const nightShiftDays = {
      "ê°•ì„±í•„": ["2025-05-05", "2025-05-06", "2025-05-08", "2025-05-09", "2025-05-10", "2025-05-11", "2025-06-10", "2025-06-11", "2025-06-12", "2025-06-13", "2025-06-14", "2025-06-15"],
      "ê¹€ë¯¸ì˜": ["2025-05-27", "2025-05-28", "2025-05-29", "2025-05-30", "2025-05-31", "2025-06-01"],
      "ì„ìˆœì˜¥": ["2025-05-05", "2025-05-06", "2025-05-08", "2025-05-09", "2025-05-10", "2025-05-11", "2025-06-10", "2025-06-11", "2025-06-12", "2025-06-13", "2025-06-14", "2025-06-15"],
      "ì†ì˜ë³µ": ["2025-05-05", "2025-05-06", "2025-05-08", "2025-05-09", "2025-05-10", "2025-05-11", "2025-06-10", "2025-06-11", "2025-06-12", "2025-06-13", "2025-06-14", "2025-06-15"],
      "ì†ì˜ë¶€": ["2025-05-01", "2025-05-02", "2025-05-03", "2025-05-04", "2025-06-03", "2025-06-04", "2025-06-05", "2025-06-06", "2025-06-07", "2025-06-08"],
      "ì‹¬ì¥ì‹": ["2025-05-27", "2025-05-28", "2025-05-29", "2025-05-30", "2025-05-31"],
      "ì—°ê²½ìˆœ": ["2025-05-20", "2025-05-21", "2025-05-22", "2025-05-23", "2025-05-24", "2025-05-25", "2025-06-24", "2025-06-25", "2025-06-26", "2025-06-27", "2025-06-28", "2025-06-29"],
      "ì„ê²½ìˆœ": ["2025-05-13", "2025-05-14", "2025-05-15", "2025-05-16", "2025-05-17", "2025-05-18", "2025-06-17", "2025-06-18", "2025-06-19", "2025-06-20", "2025-06-21", "2025-06-22"],
      "ì„ì£¼ì—°": ["2025-05-02", "2025-05-03", "2025-05-04", "2025-06-03", "2025-06-04", "2025-06-05", "2025-06-06", "2025-06-07", "2025-06-08"],
      "ì´ì°½ë¡€": ["2025-05-05", "2025-05-06", "2025-05-08", "2025-05-09", "2025-05-10", "2025-05-11", "2025-06-10", "2025-06-11", "2025-06-12", "2025-06-13", "2025-06-14", "2025-06-15"],
      "ìµœìŠ¹í•„": ["2025-05-20", "2025-05-21", "2025-05-22", "2025-05-23", "2025-05-24", "2025-05-25", "2025-06-24", "2025-06-25", "2025-06-26", "2025-06-27", "2025-06-28", "2025-06-29"],
      "í™ì„ ì£¼": ["2025-05-13", "2025-05-14", "2025-05-15", "2025-05-16", "2025-05-17", "2025-05-18", "2025-06-17", "2025-06-18", "2025-06-19", "2025-06-20", "2025-06-21", "2025-06-22"]
    };
    const fixedLeaveDays = {
      "ì„ì£¼ì—°": ["2025-05-09", "2025-05-15", "2025-05-21", "2025-06-01", "2025-06-06", "2025-06-12", "2025-06-18", "2025-06-24"],
      "ì†ì˜ë¶€": ["2025-05-05", "2025-05-16", "2025-05-22", "2025-06-01", "2025-06-03", "2025-06-13", "2025-06-19", "2025-06-25"],
      "ì •ë¯¸ê²½": ["2025-05-01", "2025-05-06", "2025-05-13", "2025-05-23", "2025-06-01", "2025-06-04", "2025-06-10", "2025-06-20", "2025-06-26"],
      "ê¹€ì •ê·¼": ["2025-05-02", "2025-05-08", "2025-05-14", "2025-05-20", "2025-06-01", "2025-06-05", "2025-06-11", "2025-06-17", "2025-06-27"],
      "ì´ë¯¼í•˜": ["2025-05-11", "2025-05-16", "2025-05-22", "2025-05-28", "2025-06-03", "2025-06-15", "2025-06-19", "2025-06-25"],
      "ìµœìŠ¹í•„": ["2025-05-05", "2025-05-18", "2025-05-22", "2025-05-28", "2025-06-03", "2025-06-13", "2025-06-22", "2025-06-25"],
      "ê¹€ë¯¸ì˜": ["2025-05-05", "2025-05-16", "2025-05-25", "2025-05-28", "2025-06-03", "2025-06-13", "2025-06-19", "2025-06-29"],
      "ì„ê²½ìˆœ": ["2025-05-01", "2025-05-11", "2025-05-13", "2025-05-23", "2025-05-29", "2025-06-04", "2025-06-15", "2025-06-20", "2025-06-26"],
      "ì´ìœ ë¯¸": ["2025-05-01", "2025-05-06", "2025-05-18", "2025-05-23", "2025-05-29", "2025-06-04", "2025-06-10", "2025-06-22", "2025-06-26"],
      "ì˜¤í™”ì§„": ["2025-05-01", "2025-05-06", "2025-05-13", "2025-05-25", "2025-05-29", "2025-06-04", "2025-06-10", "2025-06-20", "2025-06-29"],
      "í™ì„ ì£¼": ["2025-05-02", "2025-05-11", "2025-05-14", "2025-05-20", "2025-05-30", "2025-06-05", "2025-06-15", "2025-06-17", "2025-06-27"],
      "ì‹¬ê·œí•œ": ["2025-05-02", "2025-05-08", "2025-05-18", "2025-05-20", "2025-05-30", "2025-06-05", "2025-06-11", "2025-06-22", "2025-06-27"],
      "ê¹€ë¬¸ì •": ["2025-05-02", "2025-05-08", "2025-05-14", "2025-05-25", "2025-05-30", "2025-06-05", "2025-06-11", "2025-06-17", "2025-06-29"],
      "ì´ìœ¤í¬": ["2025-05-11", "2025-05-15", "2025-05-21", "2025-05-27", "2025-06-06", "2025-06-15", "2025-06-18", "2025-06-24"],
      "ì—°ê²½ìˆœ": ["2025-05-09", "2025-05-18", "2025-05-21", "2025-05-27", "2025-06-06", "2025-06-12", "2025-06-22", "2025-06-24"],
      "ì‹¬ì¥ì‹": ["2025-05-09", "2025-05-15", "2025-05-25", "2025-05-27", "2025-06-06", "2025-06-12", "2025-06-18", "2025-06-29"],
      "ì´ì°½ë¡€": ["2025-05-04", "2025-05-05", "2025-05-16", "2025-05-22", "2025-05-28", "2025-06-08", "2025-06-13", "2025-06-19", "2025-06-25"],
      "ê°•ì„±í•„": ["2025-05-04", "2025-05-06", "2025-05-13", "2025-05-23", "2025-05-29", "2025-06-08", "2025-06-10", "2025-06-20", "2025-06-26"],
      "ì„ìˆœì˜¥": ["2025-05-04", "2025-05-08", "2025-05-14", "2025-05-20", "2025-05-30", "2025-06-08", "2025-06-11", "2025-06-17", "2025-06-27"],
      "ì†ì˜ë³µ": ["2025-05-04", "2025-05-09", "2025-05-15", "2025-05-21", "2025-05-27", "2025-06-08", "2025-06-12", "2025-06-18", "2025-06-24"]
    };
    let days = [];

    function renderMonthOptions() {
      const select = document.getElementById("monthSelect");
      select.innerHTML = "";
      for (let m = 0; m < 12; m++) {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = `${m + 1}ì›”`;
        if (m === thisMonth) opt.selected = true;
        select.appendChild(opt);
      }
      select.onchange = () => renderDates(currentName, parseInt(select.value));
    }

    function openCheck(name) {
      currentName = name;
      document.getElementById('main').style.display = 'none';
      document.getElementById('check').style.display = 'block';
      renderMonthOptions();
      renderDates(name, thisMonth);
    }

    function renderDates(name, month) {
      const year = thisYear;
      document.getElementById('selectedName').textContent = `${name} - ${year}ë…„ ${month + 1}ì›”`;
      const area = document.getElementById('dates');
      area.innerHTML = "";
      days = generateWorkdaysForMonth(year, month);
      db.ref(`mealLogs/${name}`).once("value").then(snapshot => {
        values = snapshot.val() || {};
        const isContract = contract.includes(name);
        days.forEach(date => {
          const dow = new Date(date).getDay();
          if (isContract && dow === 1) values[date] = 'X';
          if (fixedLeaveDays[name] && fixedLeaveDays[name].includes(date)) values[date] = 'X';
          if (nightShiftDays[name] && nightShiftDays[name].includes(date)) values[date] = 'X';
        });

        let scrollTarget = null;
        days.forEach(date => {
          const row = document.createElement('div');
          const label = document.createElement('span');
          label.textContent = `${date}: `;
          const oxO = document.createElement('button');
          oxO.textContent = 'O';
          oxO.className = 'ox-btn';
          const oxX = document.createElement('button');
          oxX.textContent = 'X';
          oxX.className = 'ox-btn';

          if (date === todayISO) row.classList.add("today-highlight");
          if (date === todayISO) scrollTarget = row;

          [oxO, oxX].forEach(btn => {
            btn.onclick = () => {
              values[date] = btn.textContent;
              oxO.classList.toggle('selected', values[date] === 'O');
              oxX.classList.toggle('selected', values[date] === 'X');
            };
          });

          oxO.classList.remove('selected');
          oxX.classList.remove('selected');

          if (values[date] === 'O') {
            oxO.classList.add('selected');
          } else if (values[date] === 'X') {
            oxX.classList.add('selected');
          }

          row.appendChild(label);
          row.appendChild(oxO);
          row.appendChild(oxX);
          area.appendChild(row);
        });
        if (scrollTarget) scrollTarget.scrollIntoView({ behavior: 'smooth', block: 'center' });
      });
    }

    function goBack() {
      document.getElementById('main').style.display = 'block';
      document.getElementById('check').style.display = 'none';
    }

    function saveMealLog() {
      db.ref(`mealLogs/${currentName}`).set(values).then(() => {
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤");
        goBack();
      });
    }

    fetchHolidays(() => {
      // ê³µíœ´ì¼ ë¶ˆëŸ¬ì˜¨ ë’¤ ì´ˆê¸° ë¡œë”©
    });
  </script>
</body>
</html>
